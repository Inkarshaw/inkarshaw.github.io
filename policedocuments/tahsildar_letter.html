<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ஆளில்லா சான்று PDF ஜெனரேட்டர்</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --a4-width: 210mm;
            --a4-height: 297mm;
            --page-margin: 20mm;
        }

        body {
            font-family: 'Helvetica', Arial, sans-serif;
            background-color: #2c3e50;
            padding: 15px;
            margin: 0;
        }

        .container-fluid {
            padding: 10px;
            height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tamil-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        /* Main Layout */
        .main-content {
            display: flex;
            height: calc(100vh - 120px);
            gap: 15px;
        }

        /* Input Panel */
        .input-panel {
            width: 400px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Preview Panel */
        .preview-panel {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* A4 Preview Container */
        .a4-preview-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            background: #6c757d;
            border-radius: 4px;
            padding: 20px;
            position: relative;
        }

        /* A4 Page */
        .a4-page {
            width: var(--a4-width);
            min-height: var(--a4-height);
            background: white;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        /* Document Content */
        .document-content {
            font-family: 'Latha', 'Times New Roman', serif;
            line-height: 1.6;
            font-size: 11pt;
            height: 100%;
            padding: var(--page-margin);
            box-sizing: border-box;
        }

        /* Form Elements */
        .form-label {
            font-weight: bold;
            margin-top: 15px;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-control, .form-select {
            font-size: 14px;
            padding: 8px 12px;
            margin-bottom: 5px;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 60px;
        }

        /* Controls */
        .controls {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .btn-action {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Title Dropdown for Witness Only */
        .title-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .title-select {
            width: 120px;
        }

        .name-input {
            flex: 1;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }

            .input-panel {
                width: 100%;
                max-height: 50vh;
            }

            .a4-preview-container {
                min-height: 500px;
            }
        }

        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }

            .a4-page {
                box-shadow: none !important;
                margin: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="header">
            <h1 class="tamil-title">ஆளில்லா சான்று PDF ஜெனரேட்டர்</h1>
            <p class="mb-0 text-muted">Preview மற்றும் PDF சரியாக ஒரே மாதிரி</p>
        </div>

        <div class="main-content">
            <!-- Input Panel -->
            <div class="input-panel no-print">
                <h5 class="mb-4">ஆவண விவரங்களை நிரப்புக</h5>

                <!-- Form Fields -->
                <div class="mb-3">
                    <label class="form-label">காவல் நிலையத்தின் பெயர்:</label>
                    <select class="form-select" id="policeStation" onchange="updatePreview()">
                        <!-- Greater Chennai Police - Zone Wise Listing -->
                        <!-- Central Zone -->
                        <optgroup label="மத்திய மண்டலம்">
                            <option value="G1 - சேத்துப்பட்டு காவல் நிலையம்">G1 - சேத்துப்பட்டு காவல் நிலையம்</option>
                            <option value="G2 - கொத்தவால்சாவடி காவல் நிலையம்">G2 - கொத்தவால்சாவடி காவல் நிலையம்</option>
                            <option value="G3 - ராயப்பேட்டை காவல் நிலையம்">G3 - ராயப்பேட்டை காவல் நிலையம்</option>
                            <option value="G4 - ஜார்ஜ் டவுன் காவல் நிலையம்">G4 - ஜார்ஜ் டவுன் காவல் நிலையம்</option>
                            <option value="G5 - பட்டினம் காவல் நிலையம்">G5 - பட்டினம் காவல் நிலையம்</option>
                            <option value="G6 - வடகலைப்பாளையம் காவல் நிலையம்">G6 - வடகலைப்பாளையம் காவல் நிலையம்</option>
                            <option value="G7 - எழும்பூர் காவல் நிலையம்">G7 - எழும்பூர் காவல் நிலையம்</option>
                            <option value="G8 - கீழ்ப்பாக்கம் காவல் நிலையம்">G8 - கீழ்ப்பாக்கம் காவல் நிலையம்</option>
                            <option value="G9 - சூளை காவல் நிலையம்">G9 - சூளை காவல் நிலையம்</option>
                            <option value="G10 - சென்ட்ரல் காவல் நிலையம்">G10 - சென்ட்ரல் காவல் நிலையம்</option>
                            <option value="G11 - மவுண்ட் ரோடு காவல் நிலையம்">G11 - மவுண்ட் ரோடு காவல் நிலையம்</option>
                        </optgroup>
                        
                        <!-- North Zone -->
                        <optgroup label="வட மண்டலம்">
                            <option value="P1 - மாதவரம் காவல் நிலையம்">P1 - மாதவரம் காவல் நிலையம்</option>
                            <option value="P2 - அம்பத்தூர் காவல் நிலையம்">P2 - அம்பத்தூர் காவல் நிலையம்</option>
                            <option value="P3 - ஆலந்தூர் காவல் நிலையம்">P3 - ஆலந்தூர் காவல் நிலையம்</option>
                            <option value="P4 - செங்கல்பட்டு காவல் நிலையம்">P4 - செங்கல்பட்டு காவல் நிலையம்</option>
                            <option value="P5 - பூந்தமல்லி காவல் நிலையம்">P5 - பூந்தமல்லி காவல் நிலையம்</option>
                            <option value="P6 - அயனாவரம் காவல் நிலையம்">P6 - அயனாவரம் காவல் நிலையம்</option>
                            <option value="P7 - வள்ளலார் நகர் காவல் நிலையம்">P7 - வள்ளலார் நகர் காவல் நிலையம்</option>
                            <option value="P8 - சொய்சா நகர் காவல் நிலையம்">P8 - சொய்சா நகர் காவல் நிலையம்</option>
                            <option value="P9 - பழவந்தாங்கல் காவல் நிலையம்">P9 - பழவந்தாங்கல் காவல் நிலையம்</option>
                        </optgroup>
                        
                        <!-- South Zone -->
                        <optgroup label="தென் மண்டலம்">
                            <option value="M1 - மயிலாப்பூர் காவல் நிலையம்">M1 - மயிலாப்பூர் காவல் நிலையம்</option>
                            <option value="M2 - ஆயிரம் விளக்கு காவல் நிலையம்">M2 - ஆயிரம் விளக்கு காவல் நிலையம்</option>
                            <option value="M3 - அடையாறு காவல் நிலையம்">M3 - அடையாறு காவல் நிலையம்</option>
                            <option value="M4 - பசுமைநகர் காவல் நிலையம்">M4 - பசுமைநகர் காவல் நிலையம்</option>
                            <option value="M5 - கொளத்தூர் காவல் நிலையம்">M5 - கொளத்தூர் காவல் நிலையம்</option>
                            <option value="M6 - சைதாப்பேட்டை காவல் நிலையம்">M6 - சைதாப்பேட்டை காவல் நிலையம்</option>
                            <option value="M7 - கோட்டூர்புரம் காவல் நிலையம்">M7 - கோட்டூர்புரம் காவல் நிலையம்</option>
                            <option value="M8 - ஆவடி காவல் நிலையம்">M8 - ஆவடி காவல் நிலையம்</option>
                        </optgroup>
                        
                        <!-- West Zone -->
                        <optgroup label="மேற்கு மண்டலம்">
                            <option value="K1 - கோயம்பேடு காவல் நிலையம்">K1 - கோயம்பேடு காவல் நிலையம்</option>
                            <option value="K2 - பெரம்பூர் காவல் நிலையம்">K2 - பெரம்பூர் காவல் நிலையம்</option>
                            <option value="K3 - செனாய்நகர் காவல் நிலையம்">K3 - செனாய்நகர் காவல் நிலையம்</option>
                            <option value="K4 - காந்தி நகர் காவல் நிலையம்">K4 - காந்தி நகர் காவல் நிலையம்</option>
                            <option value="K5 - சவுகார் காவல் நிலையம்">K5 - சவுகார் காவல் நிலையம்</option>
                            <option value="K6 - வேப்பேரி காவல் நிலையம்">K6 - வேப்பேரி காவல் நிலையம்</option>
                            <option value="K7 - அமைந்தவரம் காவல் நிலையம்">K7 - அமைந்தவரம் காவல் நிலையம்</option>
                            <option value="K8 - அண்ணா நகர் காவல் நிலையம்">K8 - அண்ணா நகர் காவல் நிலையம்</option>
                        </optgroup>
                        
                        <!-- East Zone -->
                        <optgroup label="கிழக்கு மண்டலம்">
                            <option value="W1 - வேளச்சேரி காவல் நிலையம்">W1 - வேளச்சேரி காவல் நிலையம்</option>
                            <option value="W2 - கடலூர் காவல் நிலையம்">W2 - கடலூர் காவல் நிலையம்</option>
                            <option value="W3 - வண்ணாரப்பேட்டை காவல் நிலையம்">W3 - வண்ணாரப்பேட்டை காவல் நிலையம்</option>
                            <option value="W4 - பள்ளிக்கரணை காவல் நிலையம்">W4 - பள்ளிக்கரணை காவல் நிலையம்</option>
                            <option value="W5 - வில்லிவாக்கம் காவல் நிலையம்">W5 - வில்லிவாக்கம் காவல் நிலையம்</option>
                            <option value="W6 - கொடுங்கையூர் காவல் நிலையம்">W6 - கொடுங்கையூர் காவல் நிலையம்</option>
                            <option value="W7 - மீனம்பாக்கம் காவல் நிலையம்">W7 - மீனம்பாக்கம் காவல் நிலையம்</option>
                            <option value="W8 - நேவல் பேஸ் காவல் நிலையம்">W8 - நேவல் பேஸ் காவல் நிலையம்</option>
                        </optgroup>
                        
                        <!-- Other Important Police Stations -->
                        <optgroup label="பிற முக்கிய காவல் நிலையங்கள்">
                            <option value="T1 - தி.நகர் காவல் நிலையம்">T1 - தி.நகர் காவல் நிலையம்</option>
                            <option value="T2 - மாம்பலம் காவல் நிலையம்">T2 - மாம்பலம் காவல் நிலையம்</option>
                            <option value="T3 - நுங்கம்பாக்கம் காவல் நிலையம்">T3 - நுங்கம்பாக்கம் காவல் நிலையம்</option>
                            <option value="T4 - திருவான்மியூர் காவல் நிலையம்">T4 - திருவான்மியூர் காவல் நிலையம்</option>
                            <option value="T5 - வடபழநி காவல் நிலையம்">T5 - வடபழநி காவல் நிலையம்</option>
                            <option value="T6 - இராயபுரம் காவல் நிலையம்">T6 - இராயபுரம் காவல் நிலையம்</option>
                            <option value="C1 - சிதம்பரம் நகர் காவல் நிலையம்">C1 - சிதம்பரம் நகர் காவல் நிலையம்</option>
                            <option value="C2 - கன்னிகாபுரம் காவல் நிலையம்">C2 - கன்னிகாபுரம் காவல் நிலையம்</option>
                            <option value="C3 - சாஸ்திரி நகர் காவல் நிலையம்">C3 - சாஸ்திரி நகர் காவல் நிலையம்</option>
                            <option value="C4 - திரு.வி.க நகர் காவல் நிலையம்">C4 - திரு.வி.க நகர் காவல் நிலையம்</option>
                            <option value="C5 - எம்.ஜி.ஆர் நகர் காவல் நிலையம்">C5 - எம்.ஜி.ஆர் நகர் காவல் நிலையம்</option>
                        </optgroup>
                        
                        <!-- Special Police Stations -->
                        <optgroup label="சிறப்பு காவல் நிலையங்கள்">
                            <option value="SP1 - எழும்பூர் ரயில்வே காவல் நிலையம்">SP1 - எழும்பூர் ரயில்வே காவல் நிலையம்</option>
                            <option value="SP2 - வான்போக்கி பிரிவு காவல் நிலையம்">SP2 - வான்போக்கி பிரிவு காவல் நிலையம்</option>
                            <option value="SP3 - அணுஉலை காவல் நிலையம்">SP3 - அணுஉலை காவல் நிலையம்</option>
                            <option value="SP4 - பெண்கள் காவல் நிலையம்">SP4 - பெண்கள் காவல் நிலையம்</option>
                            <option value="SP5 - மருத்துவக் கல்லூரி காவல் நிலையம்">SP5 - மருத்துவக் கல்லூரி காவல் நிலையம்</option>
                            <option value="SP6 - கடலோர காவல் நிலையம்">SP6 - கடலோர காவல் நிலையம்</option>
                            <option value="SP7 - ரயில்வே சிறப்பு காவல் நிலையம்">SP7 - ரயில்வே சிறப்பு காவல் நிலையம்</option>
                            <option value="SP8 - சட்டம் ஒழுங்கு காவல் நிலையம்">SP8 - சட்டம் ஒழுங்கு காவல் நிலையம்</option>
                            <option value="SP9 - விமான நிலையம் காவல் நிலையம்">SP9 - விமான நிலையம் காவல் நிலையம்</option>
                            <option value="SP10 - பேருந்து நிலையம் காவல் நிலையம்">SP10 - பேருந்து நிலையம் காவல் நிலையம்</option>
                            <option value="SP11 - காவல் ஆணையர் அலுவலகம்">SP11 - காவல் ஆணையர் அலுவலகம்</option>
                            <option value="SP12 - திருவல்லிக்கேணி காவல் நிலையம்">SP12 - திருவல்லிக்கேணி காவல் நிலையம்</option>
                            <option value="SP13 - சென்னை சிறை காவல் நிலையம்">SP13 - சென்னை சிறை காவல் நிலையம்</option>
                        </optgroup>
                        
                        <!-- New Stations -->
                        <optgroup label="புதிய காவல் நிலையங்கள்">
                            <option value="N1 - அசோக் நகர் காவல் நிலையம்">N1 - அசோக் நகர் காவல் நிலையம்</option>
                            <option value="N2 - விசாலக்ஷி நகர் காவல் நிலையம்">N2 - விசாலக்ஷி நகர் காவல் நிலையம்</option>
                            <option value="N3 - அண்ணா சாலை காவல் நிலையம்">N3 - அண்ணா சாலை காவல் நிலையம்</option>
                        </optgroup>
                    </select>
                </div>

                <!-- வட்டாட்சியர் - SELECTABLE DROPDOWN -->
                <div class="mb-3">
                    <label class="form-label">எழும்புர் வட்டாட்சியர்:</label>
                    <select class="form-select" id="collectorName" onchange="updatePreview()">
                        <option value="வட்டாட்சியர் அவர்கள்">-- தேர்ந்தெடுக்கவும் --</option>
                        <option value="சென்னை (வடக்கு) வட்டாட்சியர்">சென்னை (வடக்கு) வட்டாட்சியர்</option>
                        <option value="திருவொற்றியூர் வட்டாட்சியர்">திருவொற்றியூர் வட்டாட்சியர்</option>
                        <option value="புறாவாக்கம் வட்டாட்சியர்">புறாவாக்கம் வட்டாட்சியர்</option>
                        <option value="பெரம்பூர் வட்டாட்சியர்">பெரம்பூர் வட்டாட்சியர்</option>
                        <option value="மாதவரம் வட்டாட்சியர்">மாதவரம் வட்டாட்சியர்</option>
                        <option value="ஆயிரம் விளக்கு வட்டாட்சியர்">ஆயிரம் விளக்கு வட்டாட்சியர்</option>
                        <option value="வில்லிவாக்கம் வட்டாட்சியர்">வில்லிவாக்கம் வட்டாட்சியர்</option>
                        <option value="அம்பத்தூர் வட்டாட்சியர்">அம்பத்தூர் வட்டாட்சியர்</option>
                        <option value="எக்மூர் வட்டாட்சியர்">எக்மூர் வட்டாட்சியர்</option>
                        <option value="மாதுராவோயல் வட்டாட்சியர்">மாதுராவோயல் வட்டாட்சியர்</option>
                        <option value="மாம்பழம் வட்டாட்சியர்">மாம்பழம் வட்டாட்சியர்</option>
                        <option value="மயிலாப்பூர் வட்டாட்சியர்">மயிலாப்பூர் வட்டாட்சியர்</option>
                        <option value="வேளச்சேரி வட்டாட்சியர்">வேளச்சேரி வட்டாட்சியர்</option>
                        <option value="தி.நகர் வட்டாட்சியர்">தி.நகர் வட்டாட்சியர்</option>
                        <option value="அளந்தூர் வட்டாட்சியர்">அளந்தூர் வட்டாட்சியர்</option>
                        <option value="சோழிங்கநல்லூர் வட்டாட்சியர்">சோழிங்கநல்லூர் வட்டாட்சியர்</option>
                    </select>
                </div>

                <!-- சாட்சி எண் -->
                <div class="mb-3">
                    <label class="form-label">சாட்சி எண்:</label>
                    <input type="text" class="form-control" id="witnessNumber" value="PW 1" oninput="updatePreview()" placeholder="எ.கா: PW 1, PW 2">
                </div>

                <!-- சாட்சி விவரங்கள் -->
                <div class="mb-3">
                    <label class="form-label">சாட்சி விவரங்கள்:</label>
                    <div class="title-section mb-2">
                        <select class="form-control title-select" id="witnessTitle" onchange="updatePreview()">
                            <option value="திரு.">திரு.</option>
                            <option value="திருமதி." selected>திருமதி.</option>
                            <option value="செல்வி.">செல்வி.</option>
                            <option value="">(இல்லை)</option>
                        </select>
                        <input type="text" class="form-control name-input" id="witnessName" value="மாலதி" oninput="updatePreview()">
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <input type="text" class="form-control" id="witnessAge" placeholder="வயது" value="31" oninput="updatePreview()">
                        </div>
                        <div class="col-6">
                            <input type="text" class="form-control" id="witnessFather" placeholder="தந்தை பெயர்" value="டி. சந்திரன்" oninput="updatePreview()">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">சாட்சி முகவரி:</label>
                    <textarea class="form-control" id="witnessAddress" rows="2" oninput="updatePreview()">எண் 7, வள்ளுவர் சாலை, செத்துப்பட்டு, சென்னை 600031</textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">தேதி:</label>
                    <input type="date" class="form-control" id="documentDate" value="2025-12-22" oninput="updatePreview()">
                </div>

                <div class="mb-3">
                    <label class="form-label">குற்ற எண்:</label>
                    <input type="text" class="form-control" id="caseNumber" value="1249/2012" oninput="updatePreview()">
                </div>

                <div class="mb-3">
                    <label class="form-label">குற்ற விதிகள்:</label>
                    <input type="text" class="form-control" id="caseSections" value="452, 326, 427, 506(i) IPC மற்றும் 109 CrPC 34 IPC" oninput="updatePreview()">
                </div>

                <div class="mb-3">
                    <label class="form-label">கூடுதல் விளக்கம்:</label>
                    <textarea class="form-control" id="additionalInfo" rows="3" oninput="updatePreview()">பார்வையில் கண்ட பு7 செத்துப்பட்டு காவல் நிலைய குற்ற வழக்கில் அரசு தரப்பு சாட்சி எண் 1 (Pறு-1) திருமதி மாலதி, வயது 31, தந்தை டி. சந்திரன், எண் 7, வள்ளுவர் சாலை, செத்துப்பட்டு, சென்னை 600031 என்பவரை நீதிமன்ற விசாரணைக்கு அழைக்க பலமுறை முயற்சித்தும் அவர் முன்பு விலாசத்தில் இல்லாததால் நீதிமன்ற விசாரணைக்கு அழைக்க இயலவில்லை. முன்பு நபரை பற்றி எந்த தகவலும் இல்லை.</textarea>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <button class="btn btn-primary btn-action" onclick="generatePDF()">
                        <i class="bi bi-file-pdf"></i> PDF உருவாக்கு & பதிவிறக்கம்
                    </button>

                    <button class="btn btn-success btn-action" onclick="printDocument()">
                        <i class="bi bi-printer"></i> ஆவணத்தை அச்சிடுக
                    </button>

                    <button class="btn btn-warning btn-action" onclick="resetForm()">
                        <i class="bi bi-arrow-clockwise"></i> படிவத்தை மீட்டமை
                    </button>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="preview-panel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">A4 ஆவண முன்னோட்டம்</h5>
                    <span class="badge bg-success">Preview = PDF</span>
                </div>

                <!-- A4 Preview Container -->
                <div class="a4-preview-container">
                    <!-- A4 Page -->
                    <div class="a4-page" id="a4Page">
                        <div class="document-content" id="previewContent">
                            <!-- Preview content will be generated here -->
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3 no-print">
                    <p class="text-muted mb-0">A4 பக்க அளவு: 210mm × 297mm | தமிழ் எழுத்துரு: Latha</p>
                    <p class="text-muted mb-0"><strong>குறிப்பு:</strong> மேலே உள்ள preview சரியாக PDF இல் வரும்</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden div for PDF generation -->
    <div id="pdfContent" style="display: none;"></div>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;

        // Function to get full name with title (for witness only)
        function getFullName(title, name) {
            if (!title || title === '(இல்லை)') {
                return name || '';
            }
            return `${title} ${name}`.trim();
        }

        // Function to extract police station name without code and "காவல் நிலையம்"
        function extractStationName(fullText) {
            // Remove code (everything before " - ")
            const withoutCode = fullText.replace(/^[A-Z0-9]+\s*-\s*/, '');
            
            // Remove "காவல் நிலையம்" at the end
            const withoutStationSuffix = withoutCode.replace(/\s*காவல் நிலையம்\s*$/, '');
            
            return withoutStationSuffix.trim() || 'சேத்துப்பட்டு';
        }

        // Function to extract police station code
        function extractStationCode(fullText) {
            // Extract code (everything before " - ")
            const match = fullText.match(/^([A-Z0-9]+)\s*-\s*/);
            return match ? match[1] : '';
        }

        // Function to extract Tahsildar office from selection
        function getTahsildarOffice(fullText) {
            // If the user selects "வட்டாட்சியர் அவர்கள்", return just "வட்டாட்சியர் அவர்கள்"
            if (fullText === "வட்டாட்சியர் அவர்கள்") {
                return "வட்டாட்சியர் அவர்கள்";
            }
            // Otherwise, extract the office name
            const officeMatch = fullText.match(/^(.*?) வட்டாட்சியர்$/);
            return officeMatch ? officeMatch[1] + " வட்டாட்சியர் அலுவலகம்" : "வட்டாட்சியர் அலுவலகம்";
        }

        // Function to get pincode based on வட்டாட்சியர் selection
        function getPincodeForCollector(collectorName) {
            const pincodeMap = {
                "சென்னை (வடக்கு) வட்டாட்சியர்": "600001",
                "திருவொற்றியூர் வட்டாட்சியர்": "600019",
                "புறாவாக்கம் வட்டாட்சியர்": "600087",
                "பெரம்பூர் வட்டாட்சியர்": "600011",
                "மாதவரம் வட்டாட்சியர்": "600060",
                "ஆயிரம் விளக்கு வட்டாட்சியர்": "600004",
                "வில்லிவாக்கம் வட்டாட்சியர்": "600049",
                "அம்பத்தூர் வட்டாட்சியர்": "600053",
                "எக்மூர் வட்டாட்சியர்": "600031",
                "மாதுராவோயல் வட்டாட்சியர்": "600095",
                "மாம்பழம் வட்டாட்சியர்": "600033",
                "மயிலாப்பூர் வட்டாட்சியர்": "600004",
                "வேளச்சேரி வட்டாட்சியர்": "600042",
                "தி.நகர் வட்டாட்சியர்": "600017",
                "அளந்தூர் வட்டாட்சியர்": "600032",
                "சோழிங்கநல்லூர் வட்டாட்சியர்": "600119",
                "வட்டாட்சியர் அவர்கள்": "600031" // Default
            };
            
            return pincodeMap[collectorName] || "600031";
        }

        // Function to get location name for the third line
        function getLocationForCollector(collectorName) {
            // For திருவொற்றியூர், show "திருவொற்றியூர்"
            if (collectorName === "திருவொற்றியூர் வட்டாட்சியர்") {
                return "திருவொற்றியூர்";
            }
            // For others, extract the location name
            const match = collectorName.match(/^(.*?)\s+வட்டாட்சியர்$/);
            if (match && match[1] !== "வட்டாட்சியர் அவர்கள்") {
                return match[1];
            }
            // Default to "சேத்துப்பட்டு"
            return "சேத்துப்பட்டு";
        }

        // Function to update preview with form values
        function updatePreview() {
            // Get form values
            const policeStationFull = document.getElementById('policeStation').value || 'G1 - சேத்துப்பட்டு காவல் நிலையம்';
            
            // Extract just the station name without code and "காவல் நிலையம்"
            const policeStationName = extractStationName(policeStationFull);
            
            // Extract the police station code
            const policeStationCode = extractStationCode(policeStationFull);
            
            // Get the full station name with code for display in the station line
            const policeStationFullName = policeStationFull;

            // Get வட்டாட்சியர் - FROM DROPDOWN
            const collectorSelection = document.getElementById('collectorName').value || 'வட்டாட்சியர் அவர்கள்';
            
            // Always show "வட்டாட்சியர் அவர்கள்" as the first line in பெறுநர்
            const receiverFirstLine = "வட்டாட்சியர் அவர்கள்";
            
            // Get the Tahsildar office for the second line
            const tahsildarOffice = getTahsildarOffice(collectorSelection);
            
            // Get pincode based on collector selection
            const receiverPincode = getPincodeForCollector(collectorSelection);
            
            // Get location name for third line
            const receiverLocation = getLocationForCollector(collectorSelection);

            // Get சாட்சி எண்
            const witnessNumber = document.getElementById('witnessNumber').value || 'PW 1';

            // Get சாட்சி விவரங்கள்
            const witnessTitle = document.getElementById('witnessTitle').value;
            const witnessName = document.getElementById('witnessName').value || 'சாட்சி';
            const fullWitnessName = getFullName(witnessTitle, witnessName);

            const witnessAge = document.getElementById('witnessAge').value || 'வயது';
            const witnessFather = document.getElementById('witnessFather').value || 'தந்தை பெயர்';
            const witnessAddress = document.getElementById('witnessAddress').value || 'முகவரி';

            const documentDate = document.getElementById('documentDate').value;
            const caseNumber = document.getElementById('caseNumber').value || 'குற்ற எண்';
            const caseSections = document.getElementById('caseSections').value || 'குற்ற விதிகள்';
            let additionalInfo = document.getElementById('additionalInfo').value || 'கூடுதல் விளக்கம்';

            // Format date
            let formattedDate = 'தேதி';
            if (documentDate) {
                const dateObj = new Date(documentDate);
                formattedDate = `${dateObj.getDate().toString().padStart(2, '0')}.${(dateObj.getMonth()+1).toString().padStart(2, '0')}.${dateObj.getFullYear()}`;
            }

            // Create the police station reference - KEEP ENGLISH CODE
            const stationReference = `${policeStationCode} ${policeStationName}`;
            
            // Update additional info with the selected police station
            // Replace "பு7 செத்துப்பட்டு" with the English code and station name
            // First, try to replace the Tamil pattern "பு7 செத்துப்பட்டு"
            const tamilPattern = /பு\d+\s+செத்துப்பட்டு/g;
            additionalInfo = additionalInfo.replace(tamilPattern, stationReference);
            
            // Also replace "பு7" alone if it exists
            const tamilCodePattern = /பு\d+/g;
            additionalInfo = additionalInfo.replace(tamilCodePattern, policeStationCode);
            
            // Replace "செத்துப்பட்டு காவல் நிலைய" with the selected station
            additionalInfo = additionalInfo.replace(/செத்துப்பட்டு காவல் நிலைய/g, `${policeStationName} காவல் நிலைய`);
            
            // Replace "செத்துப்பட்டு" if it appears alone
            additionalInfo = additionalInfo.replace(/செத்துப்பட்டு/g, policeStationName);

            // Create preview HTML
            const previewHTML = `
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 30px; padding-top: 5px;">
                    <div style="font-size: 22pt; font-weight: bold; margin-bottom: 5px; font-family: 'Latha', serif;">காவல்துறை</div>
                    <div style="height: 2px; background: #000; width: 100px; margin: 0 auto;"></div>
                </div>
                
                <!-- Sender and Receiver Addresses -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 35px;">
                    <!-- Sender -->
                    <div style="width: 48%;">
                        <div style="font-weight: bold; margin-bottom: 10px; font-size: 10.5pt; font-family: 'Latha', serif;">அனுப்புநர்</div>
                        <div style="line-height: 1.8; font-size: 10.5pt; font-family: 'Latha', serif;">
                            <div>காவல் ஆய்வாளர்</div>
                            <div>${policeStationFullName}</div>
                            <div>${policeStationName}, சென்னை 600031</div>
                        </div>
                    </div>
                    
                    <!-- Receiver -->
                    <div style="width: 48%;">
                        <div style="font-weight: bold; margin-bottom: 10px; font-size: 10.5pt; font-family: 'Latha', serif;">பெறுநர்</div>
                        <div style="line-height: 1.8; font-size: 10.5pt; font-family: 'Latha', serif;">
                            <div>${receiverFirstLine}</div>
                            <div>${tahsildarOffice}</div>
                            <div>${receiverLocation}, சென்னை ${receiverPincode}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Date -->
                <div style="text-align: right; margin-bottom: 30px;">
                    <div style="font-weight: bold; font-size: 10.5pt; font-family: 'Latha', serif;">நாள்: ${formattedDate}</div>
                </div>
                
                <!-- Reference -->
                <div style="margin-bottom: 25px;">
                    <div style="margin-bottom: 8px; font-size: 10.5pt; font-family: 'Latha', serif;">
                        <span style="font-weight: bold;">ஐயா,</span><br><br>
                        <div style="padding-left: 40px;">
                            <span style="font-weight: bold;">பார்வை:</span> காவல் நிலை குற்ற எண் ${caseNumber} U/s ${caseSections}
                        </div>
                    </div>
                </div>
                
                <!-- Subject -->
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 10.5pt; font-family: 'Latha', serif; line-height: 1.8;">
                        <div style="padding-left: 40px;">
                            <span style="font-weight: bold; display: inline-block; min-width: 60px;">டிபாருள்:</span>
                            <span style="text-align: justify; display: inline;">பார்வையில் கண்ட வழக்கில் சாட்சியாக உள்ளவரின் விலாசம் மற்றும் விபரம் பற்றி விசாரித்து சான்றிதழ் அளிக்க வேண்டுகிறது.</span>
                        </div>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div style="margin-bottom: 25px;">
                    <div style="text-align: justify; line-height: 1.8; font-size: 10.5pt; font-family: 'Latha', serif; margin-bottom: 15px;">
                        ${additionalInfo.replace('சாட்சி எண் 1', `சாட்சி எண் ${witnessNumber}`)}
                    </div>
                    <div style="text-align: justify; line-height: 1.8; font-size: 10.5pt; font-family: 'Latha', serif;">
                        எனவே பார்வையில் கண்ட வழக்கு தொடர்பாக நீதிமன்ற நடவடிக்கைக்கு முன்பு நபரின் தற்போதைய விலாசம் பற்றி விசாரணை செய்து சான்றிதழ் வழங்குமாறு கேட்டுக்கொள்ளப்படுகிறது.
                    </div>
                </div>
                
                <!-- Signature -->
                <div style="margin-top: 70px; text-align: right;">
                    <div style="width: 280px; border-top: 1px solid #000; padding-top: 8px; display: inline-block; text-align: center;">
                        <div style="font-weight: bold; margin-bottom: 5px; font-size: 10.5pt; font-family: 'Latha', serif;">காவல் ஆய்வாளர்</div>
                        <div style="margin-bottom: 3px; font-size: 10.5pt; font-family: 'Latha', serif;">${policeStationFullName}</div>
                    </div>
                </div>
            `;

            // Update preview
            document.getElementById('previewContent').innerHTML = previewHTML;

            // Update the hidden PDF content with the SAME HTML
            document.getElementById('pdfContent').innerHTML = `
                <div class="a4-page" style="width: 210mm; min-height: 297mm; background: white; font-family: 'Latha', serif; padding: 20mm; box-sizing: border-box;">
                    ${previewHTML}
                </div>
            `;
        }

        // Function to reset form
        function resetForm() {
            document.getElementById('policeStation').value = 'G1 - சேத்துப்பட்டு காவல் நிலையம்';
            
            // வட்டாட்சியர் - RESET TO DEFAULT
            document.getElementById('collectorName').value = 'வட்டாட்சியர் அவர்கள்';

            // சாட்சி எண்
            document.getElementById('witnessNumber').value = 'PW 1';

            // சாட்சி விவரங்கள்
            document.getElementById('witnessTitle').value = 'திருமதி.';
            document.getElementById('witnessName').value = 'மாலதி';
            document.getElementById('witnessAge').value = '31';
            document.getElementById('witnessFather').value = 'டி. சந்திரன்';
            document.getElementById('witnessAddress').value = 'எண் 7, வள்ளுவர் சாலை, செத்துப்பட்டு, சென்னை 600031';

            document.getElementById('documentDate').value = '2025-12-22';
            document.getElementById('caseNumber').value = '1249/2012';
            document.getElementById('caseSections').value = '452, 326, 427, 506(i) IPC மற்றும் 109 CrPC 34 IPC';
            document.getElementById('additionalInfo').value = 'பார்வையில் கண்ட பு7 செத்துப்பட்டு காவல் நிலைய குற்ற வழக்கில் அரசு தரப்பு சாட்சி எண் 1 (Pறு-1) திருமதி மாலதி, வயது 31, தந்தை டி. சந்திரன், எண் 7, வள்ளுவர் சாலை, செத்துப்பட்டு, சென்னை 600031 என்பவரை நீதிமன்ற விசாரணைக்கு அழைக்க பலமுறை முயற்சித்தும் அவர் முன்பு விலாசத்தில் இல்லாததால் நீதிமன்ற விசாரணைக்கு அழைக்க இயலவில்லை. முன்பு நபரை பற்றி எந்த தகவலும் இல்லை.';

            updatePreview();
        }

        // Function to generate and download PDF
        function generatePDF() {
            updatePreview(); // Ensure latest content

            // Get the preview element
            const previewElement = document.getElementById('a4Page');

            // Create a clone of the preview element
            const clone = previewElement.cloneNode(true);
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            clone.style.boxShadow = 'none';
            document.body.appendChild(clone);

            // Use html2canvas to capture the content
            html2canvas(clone, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                width: clone.offsetWidth,
                height: clone.offsetHeight
            }).then(canvas => {
                // Remove clone
                document.body.removeChild(clone);

                const imgData = canvas.toDataURL('image/png', 1.0);
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Calculate dimensions to fit A4 exactly
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // Add image to PDF
                pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);

                // Save the PDF
                const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
                pdf.save(`காவல்துறை_ஆவணம்_${timestamp}.pdf`);

                // Show success message
                showNotification('PDF வெற்றிகரமாக உருவாக்கப்பட்டது!', 'success');
            }).catch(error => {
                console.error('Error generating PDF:', error);
                showNotification('PDF உருவாக்கும் போது பிழை ஏற்பட்டது.', 'error');
            });
        }

        // Function to print the document
        function printDocument() {
            updatePreview();

            // Create print window
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>காவல்துறை ஆவணம்</title>
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 20mm;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                            }
                        }
                        
                        body {
                            font-family: 'Latha', serif;
                            margin: 0;
                            padding: 20mm;
                            width: 210mm;
                            min-height: 297mm;
                            box-sizing: border-box;
                            font-size: 11pt;
                            line-height: 1.6;
                        }
                    </style>
                </head>
                <body>
                    ${document.getElementById('previewContent').innerHTML}
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();

            setTimeout(() => {
                printWindow.print();
                printWindow.close();
                showNotification('அச்சிடல் தொடங்கப்பட்டது...', 'info');
            }, 500);
        }

        // Function to show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                animation: slideIn 0.3s ease;
            `;

            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updatePreview();

            // Add CSS for animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
