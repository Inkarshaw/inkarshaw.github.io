<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Request - PDF Maker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a3a8f 0%, #2c5aa0 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        header h1 {
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 0;
        }
        
        .form-section {
            flex: 1;
            min-width: 350px;
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .preview-section {
            flex: 1;
            min-width: 350px;
            padding: 25px;
            background-color: #f9f9f9;
        }
        
        .section-title {
            color: #1a3a8f;
            border-bottom: 2px solid #1a3a8f;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #1a3a8f;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 58, 143, 0.2);
        }
        
        #deceasedDetailsInput {
            height: 100px;
            min-height: 100px;
            resize: vertical;
            font-size: 16px;
            line-height: 1.5;
            padding: 15px;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #1a3a8f;
            color: white;
            flex: 2;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
            flex: 1;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
            flex: 1;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
            flex: 1;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary:hover {
            background-color: #15317a;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .document-preview {
            background-color: white;
            padding: 25px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 500px;
            font-family: 'Times New Roman', Times, serif;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .tamil-text {
            font-family: 'Latha', 'Arial Unicode MS', 'Nirmala UI', sans-serif;
        }
        
        .english-text {
            font-family: 'Times New Roman', Times, serif;
        }
        
        .preview-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .preview-header h2 {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .document-line {
            margin-bottom: 8px;
        }
        
        .from-section, .to-section {
            margin-bottom: 20px;
        }
        
        .section-heading {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .table-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: flex-start;
        }
        
        .single-column-table {
            width: 28%;
            border: 1px solid #000;
            border-collapse: collapse;
        }
        
        .single-column-table td {
            border: none;
            padding: 5px;
            vertical-align: top;
            font-size: 11px;
        }
        
        .document-table {
            width: 70%;
            border: 1px solid #000;
            border-collapse: collapse;
        }
        
        .document-table td {
            border: none;
            border-bottom: 1px solid #000;
            border-right: 1px solid #000;
            padding: 5px;
            vertical-align: top;
            font-size: 11px;
        }
        
        .document-table tr:last-child td {
            border-bottom: none;
        }
        
        .document-table td:last-child {
            border-right: none;
        }
        
        .document-table .label {
            font-weight: bold;
            width: 22%;
            font-size: 11px;
            border-right: 1px solid #000;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        .instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #1a3a8f;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .instructions h4 {
            color: #1a3a8f;
            margin-bottom: 10px;
        }
        
        .font-size-control {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .font-size-control label {
            margin-bottom: 0;
            font-size: 14px;
        }
        
        .font-size-control select {
            width: auto;
            padding: 5px 10px;
        }
        
        .table-width-control {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .table-width-control label {
            margin-bottom: 0;
            font-size: 14px;
        }
        
        .table-width-control select {
            width: auto;
            padding: 5px 10px;
        }
        
        .font-selection-control {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .font-selection-control label {
            margin-bottom: 0;
            font-size: 14px;
        }
        
        .font-selection-control select {
            width: auto;
            padding: 5px 10px;
            min-width: 150px;
        }
        
        .voice-typing-control {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .voice-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .voice-btn.active {
            background-color: #f44336;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .police-station-controls, .hospital-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .station-select-group, .station-custom-group,
        .hospital-select-group, .hospital-custom-group {
            display: flex;
            flex-direction: column;
        }
        
        .station-address-group, .hospital-address-group {
            grid-column: span 2;
        }
        
        .custom-station-input, .custom-hospital-input {
            display: none;
            margin-top: 10px;
        }
        
        .custom-station-input.active, .custom-hospital-input.active {
            display: block;
        }
        
        .station-info, .hospital-info {
            background-color: #f0f7ff;
            border: 1px solid #b6d4fe;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #0c5460;
        }
        
        .station-info h5, .hospital-info h5 {
            margin-bottom: 5px;
            color: #1a3a8f;
        }
        
        .mobile-optimized {
            /* Styles for mobile optimization */
        }
        
        .deceased-notice {
            background-color: #fff8e1;
            border: 1px solid #ffe57f;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #ff6f00;
        }
        
        .speech-input-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #1a3a8f;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            z-index: 2;
        }
        
        .speech-input-button:hover {
            color: #15317a;
        }
        
        input[type="text"], textarea {
            padding-right: 40px !important;
        }
        
        .crime-number-input {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .crime-number-input h4 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .crime-number-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .crime-number-group .form-group {
            margin-bottom: 0;
        }
        
        .station-display-box {
            background-color: #e8f4fd;
            border: 1px solid #b6d4fe;
            border-radius: 5px;
            padding: 12px;
            font-size: 14px;
            color: #0c5460;
            font-weight: 600;
            display: flex;
            align-items: flex-start;
            text-align: left;
            min-height: 60px;
            margin-top: 10px;
        }
        
        .station-display-box i {
            margin-right: 8px;
            color: #1a3a8f;
            margin-top: 2px;
        }
        
        .station-display-content {
            flex: 1;
        }
        
        .station-display-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1a3a8f;
            font-size: 13px;
        }
        
        .station-display-value {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .indent-control {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .indent-control label {
            margin-bottom: 0;
            font-size: 14px;
        }
        
        .indent-control select {
            width: auto;
            padding: 5px 10px;
        }
        
        /* Hidden sections */
        .hidden-section {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .form-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .table-container {
                flex-direction: column;
            }
            
            .single-column-table,
            .document-table {
                width: 100%;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .font-selection-control, 
            .table-width-control,
            .font-size-control,
            .indent-control,
            .police-station-controls,
            .hospital-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .police-station-controls,
            .hospital-controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .station-address-group,
            .hospital-address-group {
                grid-column: span 1;
            }
            
            .font-selection-control select,
            .table-width-control select,
            .font-size-control select,
            .indent-control select {
                width: 100%;
            }
            
            .voice-typing-control {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .voice-btn {
                width: 100%;
                justify-content: center;
            }
            
            .speech-input-button {
                right: 5px;
                font-size: 20px;
                padding: 8px;
            }
            
            .crime-number-group {
                grid-template-columns: 1fr;
            }
            
            .station-display-box {
                min-height: 50px;
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .form-section, .preview-section {
                padding: 15px;
            }
            
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Improve touch targets */
            .btn {
                padding: 16px 20px;
                min-height: 54px;
            }
            
            select {
                min-height: 44px;
            }
        }
    </style>
    
    <!-- Tamil fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&display=swap');
        
        @font-face {
            font-family: 'Latha';
            src: local('Latha'),
                 url('https://fonts.gstatic.com/s/latha/v11/SZc73FHnibV8eUZKd8q9.woff2') format('woff2'),
                 url('https://cdn.jsdelivr.net/gh/googlefonts/noto-fonts@master/unhinted/ttf/NotoSansTamil/NotoSansTamil-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        .font-latha {
            font-family: 'Latha', 'Arial Unicode MS', 'Nirmala UI', sans-serif;
        }
        
        .font-noto {
            font-family: 'Noto Sans Tamil', sans-serif;
        }
        
        .font-avanam {
            font-family: 'Aavanam', 'Latha', sans-serif;
        }
        
        .font-bamini {
            font-family: 'Bamini', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-file-pdf"></i> PM Request - PDF Maker</h1>
            <p>Fill out the form below to generate a PDF with Tamil font</p>
        </header>
        
        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-edit"></i> Document Details</h2>
                
                <div class="font-selection-control">
                    <label for="tamilFontSelect"><i class="fas fa-font"></i> Tamil Font:</label>
                    <select id="tamilFontSelect">
                        <option value="Latha" selected>Latha (Standard Windows)</option>
                        <option value="Noto Sans Tamil">Noto Sans Tamil (Google)</option>
                        <option value="Aavanam">Aavanam</option>
                        <option value="Bamini">Bamini</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <h3 style="color: #1a3a8f; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        <i class="fas fa-paper-plane"></i> Sender (அனுப்புநர்) Details
                    </h3>
                    
                    <div class="police-station-controls">
                        <div class="station-select-group">
                            <label for="policeStationSelect"><i class="fas fa-building"></i> Select Police Station:</label>
                            <select id="policeStationSelect">
                                <option value="">-- Select Police Station --</option>
                                <option value="G7" selected>G7 (சி.சி.பி., சீர்மை)</option>
                                <option value="G1">G1 (அயன் அவென்யூ)</option>
                                <option value="G2">G2 (கீழ்ப்பாக்கம்)</option>
                                <option value="G3">G3 (சாஸ்திரி நகர்)</option>
                                <option value="G4">G4 (தியாகராய நகர்)</option>
                                <option value="G5">G5 (கோட்டூர்புரம்)</option>
                                <option value="G6">G6 (வேப்பேரி)</option>
                                <option value="G8">G8 (தேனாம்பேட்டை)</option>
                                <option value="G9">G9 (அண்ணா நகர்)</option>
                                <option value="G10">G10 (சைதாப்பேட்டை)</option>
                                <option value="custom">-- Enter Custom Station --</option>
                            </select>
                        </div>
                        
                        <div class="station-custom-group">
                            <label for="policeStationCustom"><i class="fas fa-edit"></i> Custom Station Code:</label>
                            <div class="field-with-voice">
                                <input type="text" id="policeStationCustom" placeholder="Enter custom station code" style="display: none;">
                                <button class="speech-input-button" data-target="policeStationCustom" style="display: none;">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="station-address-group">
                            <label for="policeStationAddress"><i class="fas fa-map-marker-alt"></i> Station Address:</label>
                            <div class="field-with-voice">
                                <input type="text" id="policeStationAddress" placeholder="Station address will auto-fill" value="சீர்மை, சென்னை - 600 090">
                                <button class="speech-input-button" data-target="policeStationAddress">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="station-info">
                        <h5><i class="fas fa-info-circle"></i> Selected Station Information:</h5>
                        <div id="stationInfoText">G7 Police Station (சி.சி.பி., சீர்மை), சீர்மை, சென்னை - 600 090</div>
                    </div>
                </div>
                
                <div class="crime-number-input">
                    <h4><i class="fas fa-file-invoice"></i> Crime Number Details (பார்வை பிரிவு)</h4>
                    <p style="font-size: 14px; margin-bottom: 10px; color: #856404;">
                        <i class="fas fa-info-circle"></i> Full station name is automatically taken from the selected police station above. Enter only the crime number.
                    </p>
                    
                    <div class="crime-number-group">
                        <div class="form-group">
                            <label for="crimeNumber"><i class="fas fa-hashtag"></i> Crime Number:</label>
                            <div class="field-with-voice">
                                <input type="text" id="crimeNumber" placeholder="e.g., 216-2025" value="216-2025">
                                <button class="speech-input-button" data-target="crimeNumber">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">Crime Register Number (e.g., 216-2025)</p>
                        </div>
                    </div>
                    
                    <div class="station-display-box">
                        <i class="fas fa-info-circle"></i>
                        <div class="station-display-content">
                            <div class="station-display-title">Reference will use:</div>
                            <div class="station-display-value" id="fullStationReference">G7 நிர்வாக காவல் நிலைய (சி.சி.பி., சீர்மை) fhty; epiya Fw;w vz; 216-2025</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <h3 style="color: #1a3a8f; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        <i class="fas fa-envelope"></i> Receiver (பெறுநர்) Details
                    </h3>
                    
                    <div class="hospital-controls">
                        <div class="hospital-select-group">
                            <label for="hospitalSelect"><i class="fas fa-hospital"></i> Select Hospital/Office:</label>
                            <select id="hospitalSelect">
                                <option value="">-- Select Hospital/Office --</option>
                                <option value="kpgmc" selected>கீழ்ப்பாக்கம் அரசு மருத்துவக் கல்லூரி மருத்துவமனை</option>
                                <option value="gh">அரசு மருத்துவமனை (பொது மருத்துவமனை)</option>
                                <option value="cmc">வி.எஸ். மருத்துவமனை</option>
                                <option value="rgmc">ராஜா முத்தையா அரசு மருத்துவக் கல்லூரி மருத்துவமனை</option>
                                <option value="kmch">கோவை மருத்துவக் கல்லூரி மருத்துவமனை</option>
                                <option value="mgh">மகாத்மா காந்தி அரசு மருத்துவமனை</option>
                                <option value="custom">-- Enter Custom Hospital/Office --</option>
                            </select>
                        </div>
                        
                        <div class="hospital-custom-group">
                            <label for="hospitalCustom"><i class="fas fa-edit"></i> Custom Hospital/Office:</label>
                            <div class="field-with-voice">
                                <input type="text" id="hospitalCustom" placeholder="Enter custom hospital/office name" style="display: none;">
                                <button class="speech-input-button" data-target="hospitalCustom" style="display: none;">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="hospital-address-group">
                            <label for="hospitalAddress"><i class="fas fa-map-marker-alt"></i> Hospital/Office Address:</label>
                            <div class="field-with-voice">
                                <input type="text" id="hospitalAddress" placeholder="Address will auto-fill" value="கீழ்ப்பாக்கம், சென்னை - 600 004">
                                <button class="speech-input-button" data-target="hospitalAddress">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="hospital-info">
                        <h5><i class="fas fa-info-circle"></i> Selected Hospital Information:</h5>
                        <div id="hospitalInfoText">கீழ்ப்பாக்கம் அரசு மருத்துவக் கல்லூரி மருத்துவமனை, கீழ்ப்பாக்கம், சென்னை - 600 004</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <h3 style="color: #1a3a8f; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        <i class="fas fa-columns"></i> Deceased Details Section
                    </h3>
                    
                    <div class="form-group">
                        <label for="deceasedDetailsInput">Deceased Details Information</label>
                        <div class="field-with-voice">
                            <textarea id="deceasedDetailsInput" rows="6" placeholder="Enter deceased details information" style="height: 90px;">இறந்தவரின் பெயர் மற்றும் விலாசம்</textarea>
                            <button class="speech-input-button" data-target="deceasedDetailsInput">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="subject">Subject (பொருள்)</label>
                    <div class="field-with-voice">
                        <textarea id="subject" rows="2" placeholder="Enter the subject of the document">பிரேத பரிசோதனை செய்து சான்று வழங்க வேண்டுதல் தொடர்பாக</textarea>
                        <button class="speech-input-button" data-target="subject">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Police Officer Details Field (Visible) -->
                <div class="form-group">
                    <h3 style="color: #1a3a8f; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        <i class="fas fa-user-shield"></i> Police Officer Details
                    </h3>
                    
                    <div class="form-group">
                        <label for="policeOfficerDetails">Police Officer Details (முதல் நிலை காவலர் விவரங்கள்)</label>
                        <div class="field-with-voice">
                            <input type="text" id="policeOfficerDetails" placeholder="Enter police officer details" value="முதல் நிலை காவலர் 43606 திரு. திருமுருகன்">
                            <button class="speech-input-button" data-target="policeOfficerDetails">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden Deceased Description Sections -->
                <div class="hidden-section">
                    <div class="form-group">
                        <h3 style="color: #1a3a8f; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            <i class="fas fa-file-alt"></i> Deceased Description
                        </h3>
                        
                        <div class="deceased-notice">
                            <i class="fas fa-sync-alt"></i> <strong>Note:</strong> Hospital name in deceased description will auto-update when you select a hospital.
                        </div>
                        
                        <div class="form-group">
                            <label for="deceasedDescription">Deceased Description (விளக்க விபரங்கள்)</label>
                            <div class="field-with-voice">
                                <textarea id="deceasedDescription" rows="3" placeholder="Detailed description of deceased person">இதன் பார்வையில் கண்ட வழக்கில் சம்பந்தப்பட்டு இறந்து போன இதன் மார்ஜினில் கண்ட பிரேதம் கீழ்ப்பாக்கம் அரசு மருத்துவக்கல்லூரி மருத்துவமனை சவக்கிடங்கில் உள்ளது. மேற்படி பிரேதத்தை</textarea>
                                <button class="speech-input-button" data-target="deceasedDescription">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="deceasedDescriptionEnd">Deceased Description End (முடிவு பகுதி)</label>
                            <div class="field-with-voice">
                                <textarea id="deceasedDescriptionEnd" rows="2" placeholder="End part of deceased description">என்பவர் மூலமாக அனுப்பி வைக்கப்படுகிறது. மேற்படி பிரேதத்தை பிரேத பரிசோதனை செய்து அசல் சான்றிதழ் வழங்குமாறு கேட்டுக்கொள்கிறது.</textarea>
                                <button class="speech-input-button" data-target="deceasedDescriptionEnd">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="indent-control">
                    <label for="indentSize"><i class="fas fa-indent"></i> "இதன் பார்வையில்" Indent:</label>
                    <select id="indentSize">
                        <option value="0">No Indent</option>
                        <option value="20" selected>Small (20px)</option>
                        <option value="40">Medium (40px)</option>
                        <option value="60">Large (60px)</option>
                    </select>
                </div>
                
                <div class="table-width-control">
                    <label for="leftTableWidth">Left Table Width:</label>
                    <select id="leftTableWidth">
                        <option value="25">Narrow (25%)</option>
                        <option value="28" selected>Medium (28%)</option>
                        <option value="30">Wide (30%)</option>
                    </select>
                </div>
                
                <div class="font-size-control">
                    <label for="fontSize">PDF Font Size:</label>
                    <select id="fontSize">
                        <option value="10">Small (10pt)</option>
                        <option value="11" selected>Medium (11pt)</option>
                        <option value="12">Large (12pt)</option>
                    </select>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-primary" id="generatePdf">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                    <button class="btn btn-secondary" id="resetForm">
                        <i class="fas fa-redo"></i> Reset Form
                    </button>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" id="printDocument">
                        <i class="fas fa-print"></i> Print Document
                    </button>
                </div>
                
                <div class="instructions">
                    <h4><i class="fas fa-info-circle"></i> Instructions:</h4>
                    <p><strong>Crime Number:</strong> Full station name is automatically detected from police station selection.</p>
                    <p><strong>Auto-Update:</strong> Hospital name in deceased description automatically updates when hospital is selected.</p>
                    <p><strong>Voice Input:</strong> Use microphone buttons for voice input.</p>
                </div>
            </div>
            
            <div class="preview-section">
                <h2 class="section-title"><i class="fas fa-eye"></i> Document Preview</h2>
                <div class="document-preview" id="documentPreview">
                    <!-- Document preview will be generated here -->
                </div>
                <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                    <i class="fas fa-info-circle"></i> Preview updates automatically as you fill the form
                </p>
            </div>
        </div>
        
        <footer>
            <p>PM Request PDF Maker &copy; 2023 | Police Station & Hospital Selection</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const formInputs = document.querySelectorAll('input, textarea, select');
        const documentPreview = document.getElementById('documentPreview');
        const generatePdfBtn = document.getElementById('generatePdf');
        const resetFormBtn = document.getElementById('resetForm');
        const printDocumentBtn = document.getElementById('printDocument');
        const fontSizeSelect = document.getElementById('fontSize');
        const leftTableWidthSelect = document.getElementById('leftTableWidth');
        const tamilFontSelect = document.getElementById('tamilFontSelect');
        const indentSizeSelect = document.getElementById('indentSize');
        
        // Police station elements
        const policeStationSelect = document.getElementById('policeStationSelect');
        const policeStationCustom = document.getElementById('policeStationCustom');
        const policeStationCustomBtn = document.querySelector('button[data-target="policeStationCustom"]');
        const policeStationAddress = document.getElementById('policeStationAddress');
        const stationInfoText = document.getElementById('stationInfoText');
        const policeStationCustomLabel = document.querySelector('.station-custom-group label');
        
        // Hospital elements
        const hospitalSelect = document.getElementById('hospitalSelect');
        const hospitalCustom = document.getElementById('hospitalCustom');
        const hospitalCustomBtn = document.querySelector('button[data-target="hospitalCustom"]');
        const hospitalAddress = document.getElementById('hospitalAddress');
        const hospitalInfoText = document.getElementById('hospitalInfoText');
        const hospitalCustomLabel = document.querySelector('.hospital-custom-group label');
        
        // Crime number elements
        const crimeNumberInput = document.getElementById('crimeNumber');
        const fullStationReference = document.getElementById('fullStationReference');
        
        // Deceased description element (hidden but still functional)
        const deceasedDescription = document.getElementById('deceasedDescription');
        const deceasedDescriptionEnd = document.getElementById('deceasedDescriptionEnd');
        const policeOfficerDetails = document.getElementById('policeOfficerDetails');
        
        // Default values
        const defaultValues = {
            deceasedDetailsInput: 'இறந்தவரின் பெயர் மற்றும் விலாசம்',
            subject: 'பிரேத பரிசோதனை செய்து சான்று வழங்க வேண்டுதல் தொடர்பாக',
            crimeNumber: '216-2025',
            deceasedDescription: 'இதன் பார்வையில் கண்ட வழக்கில் சம்பந்தப்பட்டு இறந்து போன இதன் மார்ஜினில் கண்ட பிரேதம் கீழ்ப்பாக்கம் அரசு மருத்துவக்கல்லூரி மருத்துவமனை சவக்கிடங்கில் உள்ளது. மேற்படி பிரேதத்தை',
            policeOfficerDetails: 'முதல் நிலை காவலர் 43606 திரு. திருமுருகன்',
            deceasedDescriptionEnd: 'என்பவர் மூலமாக அனுப்பி வைக்கப்படுகிறது. மேற்படி பிரேதத்தை பிரேத பரிசோதனை செய்து அசல் சான்றிதழ் வழங்குமாறு கேட்டுக்கொள்கிறது.'
        };
        
        // Police stations data - UPDATED to use "நிலைய" instead of "நிலையம்" in reference section
        const policeStations = {
            'G7': {
                tamilName: 'G7 நிர்வாக காவல் நிலையம் (சி.சி.பி., சீர்மை)',
                tamilNameReference: 'G7 நிர்வாக காவல் நிலைய (சி.சி.பி., சீர்மை)', // For reference section
                address: 'சீர்மை, சென்னை - 600 090',
                fullName: 'G7 Police Station (CCP, Seermai)',
                code: 'G7'
            },
            'G1': {
                tamilName: 'G1 நிர்வாக காவல் நிலையம் (அயன் அவென்யூ)',
                tamilNameReference: 'G1 நிர்வாக காவல் நிலைய (அயன் அவென்யூ)',
                address: 'அயன் அவென்யூ, சென்னை - 600 018',
                fullName: 'G1 Police Station (Ayan Avenue)',
                code: 'G1'
            },
            'G2': {
                tamilName: 'G2 நிர்வாக காவல் நிலையம் (கீழ்ப்பாக்கம்)',
                tamilNameReference: 'G2 நிர்வாக காவல் நிலைய (கீழ்ப்பாக்கம்)',
                address: 'கீழ்ப்பாக்கம், சென்னை - 600 010',
                fullName: 'G2 Police Station (Kilpauk)',
                code: 'G2'
            },
            'G3': {
                tamilName: 'G3 நிர்வாக காவல் நிலையம் (சாஸ்திரி நகர்)',
                tamilNameReference: 'G3 நிர்வாக காவல் நிலைய (சாஸ்திரி நகர்)',
                address: 'சாஸ்திரி நகர், சென்னை - 600 020',
                fullName: 'G3 Police Station (Shastri Nagar)',
                code: 'G3'
            },
            'G4': {
                tamilName: 'G4 நிர்வாக காவல் நிலையம் (தியாகராய நகர்)',
                tamilNameReference: 'G4 நிர்வாக காவல் நிலைய (தியாகராய நகர்)',
                address: 'தியாகராய நகர், சென்னை - 600 017',
                fullName: 'G4 Police Station (Thyagaraya Nagar)',
                code: 'G4'
            },
            'G5': {
                tamilName: 'G5 நிர்வாக காவல் நிலையம் (கோட்டூர்புரம்)',
                tamilNameReference: 'G5 நிர்வாக காவல் நிலைய (கோட்டூர்புரம்)',
                address: 'கோட்டூர்புரம், சென்னை - 600 085',
                fullName: 'G5 Police Station (Kotturpuram)',
                code: 'G5'
            },
            'G6': {
                tamilName: 'G6 நிர்வாக காவல் நிலையம் (வேப்பேரி)',
                tamilNameReference: 'G6 நிர்வாக காவல் நிலைய (வேப்பேரி)',
                address: 'வேப்பேரி, சென்னை - 600 007',
                fullName: 'G6 Police Station (Vepery)',
                code: 'G6'
            },
            'G8': {
                tamilName: 'G8 நிர்வாக காவல் நிலையம் (தேனாம்பேட்டை)',
                tamilNameReference: 'G8 நிர்வாக காவல் நிலைய (தேனாம்பேட்டை)',
                address: 'தேனாம்பேட்டை, சென்னை - 600 018',
                fullName: 'G8 Police Station (Teynampet)',
                code: 'G8'
            },
            'G9': {
                tamilName: 'G9 நிர்வாக காவல் நிலையம் (அண்ணா நகர்)',
                tamilNameReference: 'G9 நிர்வாக காவல் நிலைய (அண்ணா நகர்)',
                address: 'அண்ணா நகர், சென்னை - 600 040',
                fullName: 'G9 Police Station (Anna Nagar)',
                code: 'G9'
            },
            'G10': {
                tamilName: 'G10 நிர்வாக காவல் நிலையம் (சைதாப்பேட்டை)',
                tamilNameReference: 'G10 நிர்வாக காவல் நிலைய (சைதாப்பேட்டை)',
                address: 'சைதாப்பேட்டை, சென்னை - 600 015',
                fullName: 'G10 Police Station (Saidapet)',
                code: 'G10'
            },
            'custom': {
                tamilName: 'Custom Police Station',
                tamilNameReference: 'Custom நிர்வாக காவல் நிலைய',
                address: '',
                fullName: 'Custom Police Station',
                code: 'Custom'
            }
        };
        
        // Hospital data
        const hospitals = {
            'kpgmc': {
                id: 'kpgmc',
                name: 'கீழ்ப்பாக்கம் அரசு மருத்துவக் கல்லூரி மருத்துவமனை',
                tamilName: 'கீழ்ப்பாக்கம் அரசு மருத்துவக் கல்லூரி மருத்துவமனை',
                shortName: 'கீழ்ப்பாக்கம் அரசு மருத்துவக்கல்லூரி மருத்துவமனை',
                address: 'கீழ்ப்பாக்கம், சென்னை - 600 004',
                fullName: 'Kilpauk Government Medical College Hospital',
                commonName: 'KGMCH'
            },
            'gh': {
                id: 'gh',
                name: 'அரசு மருத்துவமனை (பொது மருத்துவமனை)',
                tamilName: 'அரசு மருத்துவமனை',
                shortName: 'அரசு மருத்துவமனை',
                address: 'சென்னை - 600 003',
                fullName: 'Government General Hospital',
                commonName: 'GGH'
            },
            'cmc': {
                id: 'cmc',
                name: 'வி.எஸ். மருத்துவமனை',
                tamilName: 'வி.எஸ். மருத்துவமனை',
                shortName: 'வி.எஸ். மருத்துவமனை',
                address: 'அண்ணா சாலை, சென்னை - 600 002',
                fullName: 'V.S. Hospital',
                commonName: 'VSH'
            },
            'rgmc': {
                id: 'rgmc',
                name: 'ராஜா முத்தையா அரசு மருத்துவக் கல்லூரி மருத்துவமனை',
                tamilName: 'ராஜா முத்தையா அரசு மருத்துவக் கல்லூரி மருத்துவமனை',
                shortName: 'ராஜா முத்தையா அரசு மருத்துவக்கல்லூரி மருத்துவமனை',
                address: 'அண்ணா நகர், சென்னை - 600 028',
                fullName: 'Rajah Muthiah Government Medical College Hospital',
                commonName: 'RMGCH'
            },
            'kmch': {
                id: 'kmch',
                name: 'கோவை மருத்துவக் கல்லூரி மருத்துவமனை',
                tamilName: 'கோவை மருத்துவக் கல்லூரி மருத்துவமனை',
                shortName: 'கோவை மருத்துவக்கல்லூரி மருத்துவமனை',
                address: 'கோவை - 641 014',
                fullName: 'Coimbatore Medical College Hospital',
                commonName: 'CMCH'
            },
            'mgh': {
                id: 'mgh',
                name: 'மகாத்மா காந்தி அரசு மருத்துவமனை',
                tamilName: 'மகாத்மா காந்தி அரசு மருத்துவமனை',
                shortName: 'மகாத்மா காந்தி அரசு மருத்துவமனை',
                address: 'திருவல்லிக்கேணி, சென்னை - 600 005',
                fullName: 'Mahatma Gandhi Government Hospital',
                commonName: 'MGGH'
            },
            'custom': {
                id: 'custom',
                name: 'Custom Hospital/Office',
                tamilName: 'Custom மருத்துவமனை / அலுவலகம்',
                shortName: 'Custom மருத்துவமனை / அலுவலகம்',
                address: '',
                fullName: 'Custom Hospital/Office',
                commonName: 'Custom'
            }
        };
        
        // Function to show/hide custom fields
        function toggleCustomFields() {
            const policeStationValue = policeStationSelect.value;
            const hospitalValue = hospitalSelect.value;
            
            // Show/hide police station custom field
            if (policeStationValue === 'custom') {
                policeStationCustom.style.display = 'block';
                policeStationCustomBtn.style.display = 'block';
                policeStationCustomLabel.style.display = 'block';
                policeStationCustom.placeholder = 'Enter custom station code (e.g., X1, Y2)';
                policeStationAddress.value = '';
            } else {
                policeStationCustom.style.display = 'none';
                policeStationCustomBtn.style.display = 'none';
                policeStationCustomLabel.style.display = 'none';
                
                // Set address based on selected station
                const station = policeStations[policeStationValue] || policeStations['G7'];
                policeStationAddress.value = station.address;
            }
            
            // Show/hide hospital custom field
            if (hospitalValue === 'custom') {
                hospitalCustom.style.display = 'block';
                hospitalCustomBtn.style.display = 'block';
                hospitalCustomLabel.style.display = 'block';
                hospitalCustom.placeholder = 'Enter custom hospital/office name';
                hospitalAddress.value = '';
            } else {
                hospitalCustom.style.display = 'none';
                hospitalCustomBtn.style.display = 'none';
                hospitalCustomLabel.style.display = 'none';
                
                // Set address based on selected hospital
                const hospital = hospitals[hospitalValue] || hospitals['kpgmc'];
                hospitalAddress.value = hospital.address;
            }
        }
        
        // Initialize form
        function initializeForm() {
            // Set default values
            document.getElementById('deceasedDetailsInput').value = defaultValues.deceasedDetailsInput;
            document.getElementById('subject').value = defaultValues.subject;
            document.getElementById('crimeNumber').value = defaultValues.crimeNumber;
            document.getElementById('policeOfficerDetails').value = defaultValues.policeOfficerDetails;
            
            // Set hidden field values
            document.getElementById('deceasedDescription').value = defaultValues.deceasedDescription;
            document.getElementById('deceasedDescriptionEnd').value = defaultValues.deceasedDescriptionEnd;
            
            // Set default police station
            policeStationSelect.value = 'G7';
            
            // Set default hospital
            hospitalSelect.value = 'kpgmc';
            
            // Hide custom fields initially
            toggleCustomFields();
            
            updatePoliceStationInfo();
            updateHospitalInfo();
            updatePreview();
        }
        
        // Get current station full Tamil name for reference section (with "நிலைய")
        function getCurrentStationReferenceName() {
            const selectedValue = policeStationSelect.value;
            
            if (selectedValue === 'custom') {
                const customCode = policeStationCustom.value || 'Custom';
                return `${customCode} நிர்வாக காவல் நிலைய`;
            } else {
                const station = policeStations[selectedValue] || policeStations['G7'];
                return station.tamilNameReference || station.tamilName.replace('நிலையம்', 'நிலைய');
            }
        }
        
        // Get current station full Tamil name for sender details (with "நிலையம்")
        function getCurrentStationFullTamilName() {
            const selectedValue = policeStationSelect.value;
            
            if (selectedValue === 'custom') {
                const customCode = policeStationCustom.value || 'Custom';
                return `${customCode} நிர்வாக காவல் நிலையம்`;
            } else {
                const station = policeStations[selectedValue] || policeStations['G7'];
                return station.tamilName;
            }
        }
        
        // Update reference display
        function updateReferenceDisplay() {
            const stationReferenceName = getCurrentStationReferenceName();
            const crimeNumber = crimeNumberInput.value || defaultValues.crimeNumber;
            
            fullStationReference.textContent = `${stationReferenceName} fhty; epiya Fw;w vz; ${crimeNumber}`;
        }
        
        // Generate reference text from full station name (with "நிலைய") and crime number
        function generateReferenceText() {
            const stationReferenceName = getCurrentStationReferenceName();
            const crimeNumber = crimeNumberInput.value || defaultValues.crimeNumber;
            
            return `${stationReferenceName} fhty; epiya Fw;w vz; ${crimeNumber}\n\nU/S 194 BNSS`;
        }
        
        // Get selected indent size
        function getIndentSize() {
            return parseInt(indentSizeSelect.value) || 20;
        }
        
        // Generate the complete deceased description with editable police officer details and indentation
        function generateDeceasedDescription() {
            const deceasedDescriptionText = document.getElementById('deceasedDescription').value || defaultValues.deceasedDescription;
            const policeOfficerDetailsText = document.getElementById('policeOfficerDetails').value || defaultValues.policeOfficerDetails;
            const deceasedDescriptionEndText = document.getElementById('deceasedDescriptionEnd').value || defaultValues.deceasedDescriptionEnd;
            
            // Add indentation to "இதன் பார்வையில்"
            const indentSize = getIndentSize();
            const indentedDescription = deceasedDescriptionText.replace(/^இதன் பார்வையில்/, 
                `<span style="display: inline-block; margin-left: ${indentSize}px;">இதன் பார்வையில்</span>`);
            
            // Combine all parts
            return `${indentedDescription} ${policeOfficerDetailsText} ${deceasedDescriptionEndText}`;
        }
        
        // Generate receiver details with FIXED 2-line format + hospital name as 3rd line
        function generateReceiverDetails() {
            // Get selected hospital name
            let hospitalLine = '';
            if (hospitalSelect.value === 'custom') {
                hospitalLine = hospitalCustom.value || 'Custom Hospital/Office';
            } else {
                const hospital = hospitals[hospitalSelect.value] || hospitals['kpgmc'];
                hospitalLine = hospital.tamilName;
            }
            
            // ALWAYS use fixed receiver format with hospital as 3rd line:
            // 1. பேராசிரியர் அவர்கள்,
            // 2. சட்டம் சார்ந்த மருத்துவத்துறை
            // 3. [Hospital Name]
            const receiverDetails = [
                'பேராசிரியர் அவர்கள்,',    // First line: Fixed
                'சட்டம் சார்ந்த மருத்துவத்துறை',  // Second line: Fixed
                hospitalLine  // Third line: Selected hospital name
            ];
            
            return receiverDetails;
        }
        
        // Update police station information
        function updatePoliceStationInfo() {
            const selectedValue = policeStationSelect.value;
            const station = policeStations[selectedValue] || policeStations['G7'];
            
            if (selectedValue === 'custom') {
                // Show custom input is handled by toggleCustomFields()
                
                // Clear address for custom entry
                policeStationAddress.value = '';
                stationInfoText.textContent = 'Custom Police Station - Enter details above';
            } else {
                // Hide custom input is handled by toggleCustomFields()
                
                // Set address based on selected station
                policeStationAddress.value = station.address;
                
                // Update station info
                stationInfoText.textContent = `${station.fullName}, ${station.address}`;
            }
            
            // Update reference display
            updateReferenceDisplay();
            
            updatePreview();
        }
        
        // Update hospital information and deceased description
        function updateHospitalInfo() {
            const selectedValue = hospitalSelect.value;
            const hospital = hospitals[selectedValue] || hospitals['kpgmc'];
            
            if (selectedValue === 'custom') {
                // Show custom input is handled by toggleCustomFields()
                
                // Clear address for custom entry
                hospitalAddress.value = '';
                hospitalInfoText.textContent = 'Custom Hospital/Office - Enter details above';
                
                // Update deceased description with custom hospital name
                updateDeceasedDescription(hospitalCustom.value || 'Custom Hospital/Office');
            } else {
                // Hide custom input is handled by toggleCustomFields()
                
                // Set address based on selected hospital
                hospitalAddress.value = hospital.address;
                
                // Update hospital info
                hospitalInfoText.textContent = `${hospital.name}, ${hospital.address}`;
                
                // Update deceased description with selected hospital name
                updateDeceasedDescription(hospital.shortName);
            }
            
            updatePreview();
        }
        
        // Update deceased description with hospital name
        function updateDeceasedDescription(hospitalName) {
            // Create the new description with the correct hospital name
            // The standard format is: 
            // "இதன் பார்வையில் கண்ட வழக்கில் சம்பந்தப்பட்டு இறந்து போன இதன் மார்ஜினில் கண்ட பிரேதம் [HOSPITAL_NAME] சவக்கிடங்கில் உள்ளது. மேற்படி பிரேதத்தை"
            const newDescription = `இதன் பார்வையில் கண்ட வழக்கில் சம்பந்தப்பட்டு இறந்து போன இதன் மார்ஜினில் கண்ட பிரேதம் ${hospitalName} சவக்கிடங்கில் உள்ளது. மேற்படி பிரேதத்தை`;
            
            // Update the textarea
            deceasedDescription.value = newDescription;
            
            // Also update the preview immediately
            updatePreview();
        }
        
        // Get selected font size
        function getFontSize() {
            return parseInt(fontSizeSelect.value) || 11;
        }
        
        // Get selected Tamil font
        function getTamilFont() {
            return tamilFontSelect.value || 'Latha';
        }
        
        // Get font class based on selected font
        function getTamilFontClass() {
            const font = getTamilFont();
            switch(font) {
                case 'Latha': return 'font-latha';
                case 'Noto Sans Tamil': return 'font-noto';
                case 'Aavanam': return 'font-avanam';
                case 'Bamini': return 'font-bamini';
                default: return 'font-latha';
            }
        }
        
        // Get left table width
        function getLeftTableWidth() {
            return parseInt(leftTableWidthSelect.value) || 28;
        }
        
        // Get right table width (calculated)
        function getRightTableWidth() {
            const leftWidth = getLeftTableWidth();
            return 100 - leftWidth - 2; // 2% for gap
        }
        
        // Calculate line height based on font size
        function getLineHeight(fontSize) {
            return fontSize * 1.4;
        }
        
        // Check if text contains Tamil characters
        function containsTamil(text) {
            const tamilRegex = /[\u0B80-\u0BFF]/;
            return tamilRegex.test(text);
        }
        
        // Generate sender details with standard 3-line format
        function generateSenderDetails() {
            const selectedValue = policeStationSelect.value;
            let stationTamilName = '';
            let stationAddress = '';
            
            if (selectedValue === 'custom') {
                const customCode = policeStationCustom.value || 'Custom';
                stationTamilName = `${customCode} நிர்வாக காவல் நிலையம்`;
                stationAddress = policeStationAddress.value || '';
            } else {
                const station = policeStations[selectedValue] || policeStations['G7'];
                stationTamilName = station.tamilName;
                stationAddress = station.address;
            }
            
            // Build sender details array with STANDARD 3-LINE FORMAT:
            // 1. காவல் ஆய்வாளர் (fixed first line)
            // 2. Station Name
            // 3. Station Address
            const senderDetails = [
                'காவல் ஆய்வாளர்', // Fixed first line as per standard format
                stationTamilName,   // Second line: Station name
                stationAddress      // Third line: Station address
            ];
            
            return senderDetails;
        }
        
        // Generate the formatted first column content
        function generateFirstColumnContent() {
            const deceasedDetails = document.getElementById('deceasedDetailsInput').value || defaultValues.deceasedDetailsInput;
            
            // Process the deceased details as entered by user
            const lines = deceasedDetails.split('\n');
            
            // Create formatted content - ALWAYS start with "இறந்தவர்:"
            const formattedLines = [];
            
            // Add "இறந்தவர்:" as first line (bold)
            formattedLines.push('<strong>இறந்தவர்:</strong>');
            
            // Add all user input lines
            lines.forEach(line => {
                if (line.trim()) {
                    formattedLines.push(line);
                }
            });
            
            return formattedLines.join('<br>');
        }
        
        // Generate the first column content for text-based output
        function generateFirstColumnText() {
            const deceasedDetails = document.getElementById('deceasedDetailsInput').value || defaultValues.deceasedDetailsInput;
            
            // ALWAYS start with "இறந்தவர்:" followed by user input
            const lines = deceasedDetails.split('\n');
            const resultLines = ['இறந்தவர்:'];
            
            lines.forEach(line => {
                if (line.trim()) {
                    resultLines.push(line);
                }
            });
            
            return resultLines.join('\n');
        }
        
        // Generate the complete deceased description for PDF output (without HTML tags)
        function generateDeceasedDescriptionText() {
            const deceasedDescriptionText = document.getElementById('deceasedDescription').value || defaultValues.deceasedDescription;
            const policeOfficerDetailsText = document.getElementById('policeOfficerDetails').value || defaultValues.policeOfficerDetails;
            const deceasedDescriptionEndText = document.getElementById('deceasedDescriptionEnd').value || defaultValues.deceasedDescriptionEnd;
            
            // For PDF, we need to add indentation differently
            const indentSize = getIndentSize();
            const indentSpaces = ' '.repeat(indentSize / 4); // Rough approximation
            
            // Combine all parts with indentation
            return `${indentSpaces}${deceasedDescriptionText} ${policeOfficerDetailsText} ${deceasedDescriptionEndText}`;
        }
        
        // Update preview with all editable fields - NO SIGNATURE
        function updatePreview() {
            const fontSize = getFontSize();
            const lineHeight = getLineHeight(fontSize) / 12;
            const leftTableWidth = getLeftTableWidth();
            const rightTableWidth = getRightTableWidth();
            const tamilFontClass = getTamilFontClass();
            
            const subject = document.getElementById('subject').value || defaultValues.subject;
            const reference = generateReferenceText();
            
            // Generate sender details with standard 3-line format
            const senderDetails = generateSenderDetails();
            
            // Generate receiver details with FIXED 2-line format + hospital as 3rd line
            const receiverDetails = generateReceiverDetails();
            
            // Generate formatted first column content
            const firstColumnContent = generateFirstColumnContent();
            
            // Generate complete deceased description with indentation
            const deceasedDescriptionHTML = generateDeceasedDescription();
            
            // Process Sender (அனுப்புநர்) details - only 3 lines
            const fromDetailsLines = senderDetails.map(line => 
                `<div class="document-line left ${tamilFontClass}" style="font-size: ${fontSize}px; line-height: ${lineHeight}em; margin-bottom: 4px;">${line}</div>`
            ).join('');
            
            // Process Receiver (பெறுநர்) details - FIXED 2 lines + hospital as 3rd line
            const toDetailsLines = receiverDetails.map(line => 
                `<div class="document-line left ${tamilFontClass}" style="font-size: ${fontSize}px; line-height: ${lineHeight}em; margin-bottom: 4px;">${line}</div>`
            ).join('');
            
            // Process reference
            const referenceLines = reference.split('\n').map(line => {
                const fontClass = containsTamil(line) ? tamilFontClass : 'english-text';
                return `<div class="${fontClass}" style="font-size: ${fontSize - 1}px; margin-bottom: 2px;">${line}</div>`;
            }).join('');
            
            const previewHTML = `
                <div class="preview-header" style="font-size: ${fontSize + 4}px; margin-bottom: 15px;">
                    <h2 class="${tamilFontClass}" style="font-size: ${fontSize + 4}px; margin-bottom: 5px; font-weight: bold;">கோரிக்கை மனு</h2>
                </div>
                
                <div class="from-section" style="margin-bottom: 15px;">
                    <div class="section-heading ${tamilFontClass}" style="font-size: ${fontSize}px; margin-bottom: 5px; font-weight: bold;">அனுப்புநர்:</div>
                    ${fromDetailsLines}
                </div>
                
                <div class="to-section" style="margin-bottom: 15px;">
                    <div class="section-heading ${tamilFontClass}" style="font-size: ${fontSize}px; margin-bottom: 5px; font-weight: bold;">பெறுநர்:</div>
                    ${toDetailsLines}
                </div>
                
                <div class="document-line ${tamilFontClass}" style="margin: 15px 0; font-size: ${fontSize + 1}px; text-align: left;">
                    ஐயா,
                </div>
                
                <div class="table-container" style="gap: 10px; margin: 10px 0;">
                    <table class="single-column-table" style="width: ${leftTableWidth}%; border: 1px solid #000;">
                        <tr>
                            <td class="${tamilFontClass}" style="padding: 4px; font-size: ${fontSize - 1}px;">
                                ${firstColumnContent}
                            </td>
                        </tr>
                    </table>
                    
                    <table class="document-table" style="width: ${rightTableWidth}%; border: 1px solid #000;">
                        <tr>
                            <td class="label ${tamilFontClass}" style="width: 22%; padding: 4px; font-size: ${fontSize - 1}px; border-right: 1px solid #000;">பொருள்:</td>
                            <td class="${tamilFontClass} document-line justify" style="padding: 4px; font-size: ${fontSize - 1}px;">${subject}</td>
                        </tr>
                        <tr>
                            <td class="label ${tamilFontClass}" style="padding: 4px; font-size: ${fontSize - 1}px; border-right: 1px solid #000; border-bottom: 1px solid #000;">பார்வை:</td>
                            <td style="padding: 4px; font-size: ${fontSize - 1}px; border-bottom: 1px solid #000;">
                                ${referenceLines}
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div class="document-line ${tamilFontClass} justify" style="margin-top: 15px; text-align: justify; font-size: ${fontSize}px; line-height: ${lineHeight}em;">
                    ${deceasedDescriptionHTML}
                </div>
            `;
            
            documentPreview.innerHTML = previewHTML;
            documentPreview.style.fontSize = fontSize + 'px';
            documentPreview.style.lineHeight = lineHeight + 'em';
        }
        
        // Generate PDF with all editable fields - NO SIGNATURE
        function generatePDF() {
            const originalText = generatePdfBtn.innerHTML;
            generatePdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating PDF...';
            generatePdfBtn.disabled = true;
            
            try {
                const subject = document.getElementById('subject').value || defaultValues.subject;
                const reference = generateReferenceText();
                const fontSize = getFontSize();
                const lineHeight = fontSize * 1.2;
                const leftTableWidth = getLeftTableWidth();
                const rightTableWidth = getRightTableWidth();
                const tamilFont = getTamilFont();
                const indentSize = getIndentSize();
                
                // Generate sender details with standard 3-line format
                const senderDetails = generateSenderDetails();
                
                // Generate receiver details with FIXED 2-line format + hospital as 3rd line
                const receiverDetails = generateReceiverDetails();
                
                // Generate first column text
                const firstColumnText = generateFirstColumnText();
                
                // Generate complete deceased description with indentation
                const deceasedDescriptionText = generateDeceasedDescriptionText();
                
                // Create a temporary div for PDF content
                const tempDiv = document.createElement('div');
                tempDiv.style.cssText = `
                    position: absolute;
                    left: -10000px;
                    top: -10000px;
                    width: 210mm;
                    min-height: 297mm;
                    padding: 15mm;
                    background: white;
                    font-family: 'Times New Roman', Times, serif;
                    font-size: ${fontSize}pt;
                    line-height: ${lineHeight}pt;
                    box-sizing: border-box;
                `;
                
                // Determine font family for Tamil text
                let tamilFontFamily = "'Latha', 'Arial Unicode MS', sans-serif";
                switch(tamilFont) {
                    case 'Noto Sans Tamil':
                        tamilFontFamily = "'Noto Sans Tamil', sans-serif";
                        break;
                    case 'Aavanam':
                        tamilFontFamily = "'Aavanam', 'Latha', sans-serif";
                        break;
                    case 'Bamini':
                        tamilFontFamily = "'Bamini', sans-serif";
                        break;
                    default:
                        tamilFontFamily = "'Latha', 'Arial Unicode MS', sans-serif";
                }
                
                // Generate HTML with all editable fields - NO SIGNATURE
                tempDiv.innerHTML = `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h1 style="font-size: ${fontSize + 2}pt; margin-bottom: 5px; font-family: ${tamilFontFamily}; font-weight: bold;">கோரிக்கை மனு</h1>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 6px; font-size: ${fontSize}pt; font-family: ${tamilFontFamily};">அனுப்புநர்:</div>
                        ${senderDetails.map(line => `<div style="margin-bottom: 4px; font-size: ${fontSize}pt; font-family: ${tamilFontFamily};">${line}</div>`).join('')}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 6px; font-size: ${fontSize}pt; font-family: ${tamilFontFamily};">பெறுநர்:</div>
                        ${receiverDetails.map(line => `<div style="margin-bottom: 4px; font-size: ${fontSize}pt; font-family: ${tamilFontFamily};">${line}</div>`).join('')}
                    </div>
                    
                    <div style="margin: 15px 0; font-size: ${fontSize + 1}pt; font-family: ${tamilFontFamily}; text-align: left;">
                        ஐயா,
                    </div>
                    
                    <div style="display: flex; width: 100%; margin: 15px 0; gap: 10px;">
                        <div style="width: ${leftTableWidth}%; border: 1px solid #000; padding: 5px; min-height: 50px; font-family: ${tamilFontFamily}; font-size: ${fontSize}pt;">
                            ${firstColumnText.replace(/\n/g, '<br>').replace('இறந்தவர்:', '<span style="font-weight: bold;">இறந்தவர்:</span>')}
                        </div>
                        
                        <div style="width: ${rightTableWidth}%; border: 1px solid #000;">
                            <table style="width: 100%; border-collapse: collapse; font-size: ${fontSize}pt;">
                                <tr>
                                    <td style="width: 22%; border-right: 1px solid #000; border-bottom: 1px solid #000; padding: 5px; vertical-align: top; font-weight: bold; font-family: ${tamilFontFamily};">பொருள்:</td>
                                    <td style="border-bottom: 1px solid #000; padding: 5px; vertical-align: top; font-family: ${tamilFontFamily};">${subject}</td>
                                </tr>
                                <tr>
                                    <td style="border-right: 1px solid #000; padding: 5px; vertical-align: top; font-weight: bold; font-family: ${tamilFontFamily};">பார்வை:</td>
                                    <td style="padding: 5px; vertical-align: top;">
                                        ${reference.split('\n').map(line => {
                                            const fontFamily = containsTamil(line) ? tamilFontFamily : "'Times New Roman', Times, serif";
                                            return `<div style="font-family: ${fontFamily};">${line}</div>`;
                                        }).join('')}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; text-align: justify; font-family: ${tamilFontFamily}; font-size: ${fontSize}pt; line-height: ${lineHeight}pt; padding-left: ${indentSize}pt;">
                        ${deceasedDescriptionText}
                    </div>
                `;
                
                document.body.appendChild(tempDiv);
                
                // Use html2canvas to convert to image
                if (typeof html2canvas !== 'undefined') {
                    // Load appropriate font based on selection
                    let fontUrl = 'https://fonts.gstatic.com/s/latha/v11/SZc73FHnibV8eUZKd8q9.woff2';
                    if (tamilFont === 'Noto Sans Tamil') {
                        fontUrl = 'https://fonts.gstatic.com/s/notosanstamil/v22/ieVc2YdFI3GCY6SyQy1KfStzYKZgzN1z4LKDbeZce-044PPRgA.woff2';
                    }
                    
                    const fontLink = document.createElement('link');
                    fontLink.href = fontUrl;
                    fontLink.rel = 'preload';
                    fontLink.as = 'font';
                    fontLink.type = 'font/woff2';
                    fontLink.crossOrigin = 'anonymous';
                    document.head.appendChild(fontLink);
                    
                    // Wait for font to load
                    setTimeout(() => {
                        html2canvas(tempDiv, {
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            allowTaint: true,
                            fontFamily: tamilFontFamily
                        }).then(canvas => {
                            const imgData = canvas.toDataURL('image/png');
                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF('p', 'mm', 'a4');
                            
                            const imgWidth = 210;
                            const imgHeight = canvas.height * imgWidth / canvas.width;
                            
                            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                            
                            // Get station code for filename
                            const stationReferenceName = getCurrentStationReferenceName();
                            const stationCode = policeStationSelect.value === 'custom' ? 
                                (policeStationCustom.value || 'Custom') : policeStationSelect.value;
                            const crimeNumber = crimeNumberInput.value || defaultValues.crimeNumber;
                            
                            pdf.save(`PM_Request_${stationCode}_${crimeNumber}_${tamilFont.replace(/\s+/g, '_')}_${fontSize}pt.pdf`);
                            
                            document.body.removeChild(tempDiv);
                            document.head.removeChild(fontLink);
                            
                            generatePdfBtn.innerHTML = '<i class="fas fa-check"></i> PDF Downloaded!';
                            setTimeout(() => {
                                generatePdfBtn.innerHTML = originalText;
                                generatePdfBtn.disabled = false;
                            }, 3000);
                        }).catch(error => {
                            console.error('html2canvas error:', error);
                            document.head.removeChild(fontLink);
                            fallbackToPrint();
                        });
                    }, 2000);
                } else {
                    fallbackToPrint();
                }
                
            } catch (error) {
                console.error('PDF generation error:', error);
                fallbackToPrint();
                
                generatePdfBtn.innerHTML = originalText;
                generatePdfBtn.disabled = false;
            }
        }
        
        // Fallback to print if PDF generation fails
        function fallbackToPrint() {
            alert('PDF generation failed. Opening print dialog instead.');
            printDocument();
            generatePdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF';
            generatePdfBtn.disabled = false;
        }
        
        // Print document with all editable fields - NO SIGNATURE
        function printDocument() {
            const printWindow = window.open('', '_blank');
            const subject = document.getElementById('subject').value || defaultValues.subject;
            const reference = generateReferenceText();
            const fontSize = getFontSize();
            const lineHeight = fontSize * 1.2;
            const leftTableWidth = getLeftTableWidth();
            const rightTableWidth = getRightTableWidth();
            const tamilFont = getTamilFont();
            const indentSize = getIndentSize();
            
            // Generate sender details with standard 3-line format
            const senderDetails = generateSenderDetails();
            
            // Generate receiver details with FIXED 2-line format + hospital as 3rd line
            const receiverDetails = generateReceiverDetails();
            
            // Generate first column text
            const firstColumnText = generateFirstColumnText();
            
            // Generate complete deceased description with indentation
            const deceasedDescriptionText = generateDeceasedDescriptionText();
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>PM Request Document</title>
                    <meta charset="UTF-8">
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        @font-face {
                            font-family: 'Latha';
                            src: url('https://fonts.gstatic.com/s/latha/v11/SZc73FHnibV8eUZKd8q9.woff2') format('woff2');
                            font-display: swap;
                        }
                        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&display=swap');
                        
                        body {
                            font-family: 'Times New Roman', Times, serif;
                            font-size: ${fontSize}pt;
                            line-height: ${lineHeight}pt;
                            margin: 0;
                            padding: 0;
                        }
                        .tamil {
                            font-family: '${tamilFont}', 'Latha', 'Arial Unicode MS', 'Nirmala UI', sans-serif;
                        }
                        .english {
                            font-family: 'Times New Roman', Times, serif;
                        }
                        .document-container {
                            width: 210mm;
                            min-height: 297mm;
                            padding: 15mm;
                            margin: 0 auto;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 15px;
                        }
                        .header h1 {
                            font-size: ${fontSize + 2}pt;
                            margin-bottom: 5px;
                            font-weight: bold;
                        }
                        .section {
                            margin-bottom: 15px;
                        }
                        .section-heading {
                            font-weight: bold;
                            margin-bottom: 6px;
                            font-family: '${tamilFont}', 'Latha', 'Arial Unicode MS', sans-serif;
                        }
                        .content-line {
                            margin-bottom: 4px;
                        }
                        .salutation {
                            margin: 15px 0;
                            font-size: ${fontSize + 1}pt;
                            text-align: left;
                        }
                        .table-container {
                            display: flex;
                            width: 100%;
                            margin: 15px 0;
                            gap: 10px;
                        }
                        .left-table {
                            width: ${leftTableWidth}%;
                            border: 1px solid #000;
                            padding: 5px;
                            min-height: 50px;
                        }
                        .right-table {
                            width: ${rightTableWidth}%;
                            border: 1px solid #000;
                        }
                        .right-table table {
                            width: 100%;
                            border-collapse: collapse;
                            border: 1px solid #000;
                        }
                        .right-table td {
                            padding: 5px;
                            vertical-align: top;
                        }
                        .right-table .label {
                            width: 22%;
                            font-weight: bold;
                            border-right: 1px solid #000;
                            border-bottom: 1px solid #000;
                        }
                        .right-table tr:last-child .label {
                            border-bottom: 1px solid #000;
                        }
                        .right-table tr:last-child td:last-child {
                            border-bottom: none;
                        }
                        .details {
                            margin: 15px 0;
                            text-align: justify;
                            padding-left: ${indentSize}pt;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            .document-container {
                                padding: 0;
                                margin: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="document-container">
                        <div class="header">
                            <h1 class="tamil">கோரிக்கை மனு</h1>
                        </div>
                        
                        <div class="section">
                            <div class="section-heading tamil">அனுப்புநர்:</div>
                            ${senderDetails.map(line => 
                                `<div class="content-line tamil">${line}</div>`
                            ).join('')}
                        </div>
                        
                        <div class="section">
                            <div class="section-heading tamil">பெறுநர்:</div>
                            ${receiverDetails.map(line => 
                                `<div class="content-line tamil">${line}</div>`
                            ).join('')}
                        </div>
                        
                        <div class="salutation tamil">
                            ஐயா,
                        </div>
                        
                        <div class="table-container">
                            <div class="left-table tamil">
                                ${firstColumnText.replace(/\n/g, '<br>').replace('இறந்தவர்:', '<span class="bold">இறந்தவர்:</span>')}
                            </div>
                            
                            <div class="right-table">
                                <table>
                                    <tr>
                                        <td class="label tamil">பொருள்:</td>
                                        <td class="tamil" style="border-bottom: 1px solid #000;">${subject}</td>
                                    </tr>
                                    <tr>
                                        <td class="label tamil">பார்வை:</td>
                                        <td>
                                            ${reference.split('\n').map(line => {
                                                const fontClass = /[\u0B80-\u0BFF]/.test(line) ? 'tamil' : 'english';
                                                return `<div class="${fontClass}">${line}</div>`;
                                            }).join('')}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <div class="details tamil">
                            ${deceasedDescriptionText}
                        </div>
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.focus();
                            setTimeout(function() {
                                window.print();
                            }, 1500);
                            
                            window.onafterprint = function() {
                                setTimeout(function() {
                                    window.close();
                                }, 500);
                            };
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Reset form
        function resetForm() {
            if (confirm('Are you sure you want to reset all fields to default values?')) {
                initializeForm();
            }
        }
        
        // Event Listeners
        formInputs.forEach(input => {
            input.addEventListener('input', updatePreview);
        });
        
        // Add event listeners for crime number fields
        crimeNumberInput.addEventListener('input', function() {
            updateReferenceDisplay();
            updatePreview();
        });
        policeStationCustom.addEventListener('input', function() {
            updateReferenceDisplay();
            updatePreview();
        });
        
        fontSizeSelect.addEventListener('change', updatePreview);
        leftTableWidthSelect.addEventListener('change', updatePreview);
        tamilFontSelect.addEventListener('change', updatePreview);
        indentSizeSelect.addEventListener('change', updatePreview);
        
        // Police station event listeners
        policeStationSelect.addEventListener('change', function() {
            toggleCustomFields();
            updatePoliceStationInfo();
            updateReferenceDisplay();
        });
        policeStationAddress.addEventListener('input', updatePreview);
        
        // Hospital event listeners
        hospitalSelect.addEventListener('change', function() {
            toggleCustomFields();
            updateHospitalInfo();
        });
        hospitalCustom.addEventListener('input', function() {
            updatePreview();
            if (hospitalSelect.value === 'custom') {
                updateDeceasedDescription(hospitalCustom.value);
            }
        });
        hospitalAddress.addEventListener('input', updatePreview);
        
        generatePdfBtn.addEventListener('click', generatePDF);
        resetFormBtn.addEventListener('click', resetForm);
        printDocumentBtn.addEventListener('click', printDocument);
        
        // Speech button events
        document.addEventListener('click', function(e) {
            if (e.target.closest('.speech-input-button')) {
                const button = e.target.closest('.speech-input-button');
                const targetFieldId = button.getAttribute('data-target');
                const field = document.getElementById(targetFieldId);
                if (field) {
                    field.focus();
                }
            }
        });
        
        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
        });
    </script>
    
    <!-- Load html2canvas library -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>
