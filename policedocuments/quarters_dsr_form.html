<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily DSR PDF & Image Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #2c3e50;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .form-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: #3498db;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            text-align: left;
            padding: 15px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f7fd;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 140px;
        }
        
        .btn-generate {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-generate:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }
        
        .btn-reset {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-reset:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-preview {
            background-color: #3498db;
            color: white;
        }
        
        .btn-preview:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-image {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-image:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }
        
        .preview-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-top: 30px;
            display: none;
        }
        
        .preview-title {
            font-size: 1.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .preview-content {
            font-family: Arial, sans-serif;
            background-color: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .image-options-container {
            display: none;
            margin-top: 20px;
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #9b59b6;
        }
        
        .image-options-container h3 {
            color: #9b59b6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .image-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .image-preview {
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            min-height: 200px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-preview img {
            width: 100%;
            display: block;
            max-height: 500px;
            object-fit: contain;
        }
        
        .image-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .image-format-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .format-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .format-option:hover {
            background-color: #f0f0f0;
        }
        
        .format-option.selected {
            background-color: #9b59b6;
            color: white;
            border-color: #9b59b6;
        }
        
        .image-quality-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .quality-slider {
            width: 300px;
            max-width: 100%;
        }
        
        .quality-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .status-message {
            padding: 12px 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
            }
            
            .preview-title {
                flex-direction: column;
                text-align: center;
            }
            
            .image-actions {
                flex-direction: column;
            }
            
            .image-format-options {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-file-pdf"></i> Daily DSR Generator</h1>
            <p class="subtitle">Generate PDF or Image format reports</p>
        </header>
        
        <div class="status-message" id="statusMessage"></div>
        
        <div class="form-container">
            <div class="section">
                <h2 class="section-title"><i class="fas fa-calendar-alt"></i> Report Details</h2>
                <div class="grid-container">
                    <div class="input-group">
                        <label for="reportDate">Report Date</label>
                        <input type="date" id="reportDate" value="2025-02-12">
                    </div>
                    <div class="input-group">
                        <label for="quarterName">Quarter Name</label>
                        <input type="text" id="quarterName" value="LUTHARAL GARDEN AR QUARTER NEW">
                    </div>
                    <div class="input-group">
                        <label for="supervisorName">Supervisor Name</label>
                        <input type="text" id="supervisorName" value="G.MATHIYAZHAGAN. SSI.">
                    </div>
                    <div class="input-group">
                        <label for="phoneNumber">Phone Number</label>
                        <input type="text" id="phoneNumber" value="+9841396946">
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i> DSR Items</h2>
                <div class="table-container">
                    <table id="dsrTable">
                        <thead>
                            <tr>
                                <th width="10%">S.No</th>
                                <th width="60%">PARTICULARS</th>
                                <th width="30%">DETAILS</th>
                            </tr>
                        </thead>
                        <tbody id="dsrTableBody">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="button-group">
                <button type="button" class="btn-preview" id="previewBtn">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button type="button" class="btn-generate" id="generateBtn">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button type="button" class="btn-image" id="imageBtn">
                    <i class="fas fa-image"></i> Image
                </button>
                <button type="button" class="btn-reset" id="resetBtn">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </div>
        
        <div class="preview-container" id="previewContainer">
            <h2 class="preview-title">
                <span><i class="fas fa-print"></i> DSR Preview</span>
                <div>
                    <button type="button" class="btn-preview" id="printPreviewBtn" style="padding: 8px 15px; font-size: 0.9rem; margin-right: 10px;">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn-image" id="imagePreviewBtn" style="padding: 8px 15px; font-size: 0.9rem;">
                        <i class="fas fa-image"></i> Save as Image
                    </button>
                </div>
            </h2>
            <div class="preview-content" id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
        
        <div class="image-options-container" id="imageOptionsContainer">
            <h3><i class="fas fa-image"></i> Save as Image</h3>
            
            <div class="image-format-options">
                <div class="format-option selected" data-format="png" id="formatPng">
                    <i class="fas fa-file-image"></i> PNG Format (Best Quality)
                </div>
                <div class="format-option" data-format="jpeg" id="formatJpeg">
                    <i class="fas fa-file-image"></i> JPEG Format (Smaller File)
                </div>
            </div>
            
            <div class="image-quality-options" id="qualityOptions" style="display: none;">
                <label class="quality-label">Image Quality: <span id="qualityValue">90</span>%</label>
                <input type="range" min="10" max="100" value="90" class="quality-slider" id="qualitySlider">
            </div>
            
            <div class="image-preview-container">
                <div class="image-preview" id="imagePreview">
                    <div id="imageLoading" style="display: none; padding: 40px; text-align: center;">
                        <div class="loading"></div>
                        <p style="margin-top: 15px; color: #666;">Generating image...</p>
                    </div>
                    <!-- Image preview will be inserted here -->
                </div>
            </div>
            
            <div class="image-actions">
                <button type="button" class="btn-image" id="downloadImageBtn">
                    <i class="fas fa-download"></i> Download Image
                </button>
                <button type="button" class="btn-preview" id="copyImageBtn">
                    <i class="fas fa-copy"></i> Copy to Clipboard
                </button>
                <button type="button" class="btn-reset" id="cancelImageBtn" style="background-color: #95a5a6;">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
            
            <p style="margin-top: 15px; font-size: 0.85rem; color: #666;">
                <i class="fas fa-info-circle"></i> Tip: PNG format is best for documents. JPEG is better for sharing.
            </p>
        </div>
        
        <div class="footer">
            <p>Daily DSR Generator | PDF & Image Formats | Created for Quarters Management System</p>
            <p>Generate professional DSR reports in PDF or Image format for easy sharing and printing.</p>
        </div>
    </div>

    <script>
        // DSR data from the document
        const dsrItems = [
            { id: 1, particulars: "ANY ELECTRIC ISSUE REPORTED", details: "Nil" },
            { id: 2, particulars: "ANY DRAINAGE ISSUE REPORTED", details: "Nil" },
            { id: 3, particulars: "ANY DRINKING WATER ISSUE REPORTED", details: "Nil" },
            { id: 4, particulars: "ANY QUARTERS ISSUE REPORTED", details: "Nil" },
            { id: 5, particulars: "ANY QUARTERS VACATED YESTERDAY", details: "Nil" },
            { id: 6, particulars: "ANY QUARTERS DAMAGE REPORTED YESTERDAY", details: "Nil" },
            { id: 7, particulars: "ANY DUES TO BE PAID", details: "Nil" },
            { id: 8, particulars: "OCCUPANCY STATUS", details: "100 /100" },
            { id: 9, particulars: "ANY PROBLEM IN UNOCCUPIED AREAS IN QUARTER", details: "Nil" },
            { id: 10, particulars: "VEHICLE PARKING ISSUE", details: "Nil" },
            { id: 11, particulars: "PET ANIMALS MENACE", details: "Nil" },
            { id: 12, particulars: "WHAT ARE THE YESTERDAY PROBLEM SORTED OUT DETAILS", details: "Nil" },
            { id: 13, particulars: "IF NOT SORTED OUT WHAT IS THE REASON AND WHEN IT WILL BE SOLVED", details: "Nil" }
        ];

        // Global variables for image generation
        let currentImageData = null;
        let currentImageFormat = 'png';
        let currentImageQuality = 0.9;

        // Show status message
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }

        // Populate the table with DSR items
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.getElementById('dsrTableBody');
            
            dsrItems.forEach(item => {
                const row = document.createElement('tr');
                
                // Serial number cell
                const snoCell = document.createElement('td');
                snoCell.textContent = item.id;
                row.appendChild(snoCell);
                
                // Particulars cell
                const particularsCell = document.createElement('td');
                particularsCell.textContent = item.particulars;
                row.appendChild(particularsCell);
                
                // Details cell with input field
                const detailsCell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'text';
                input.value = item.details;
                input.id = `item-${item.id}`;
                input.className = 'detail-input';
                detailsCell.appendChild(input);
                row.appendChild(detailsCell);
                
                tableBody.appendChild(row);
            });
            
            // Set up event listeners
            document.getElementById('previewBtn').addEventListener('click', previewDSR);
            document.getElementById('generateBtn').addEventListener('click', generatePDF);
            document.getElementById('imageBtn').addEventListener('click', generateImage);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.getElementById('printPreviewBtn').addEventListener('click', printPreview);
            document.getElementById('imagePreviewBtn').addEventListener('click', function() {
                previewDSR();
                setTimeout(() => {
                    generateImage();
                }, 500);
            });
            
            // Image options event listeners
            document.getElementById('formatPng').addEventListener('click', () => selectFormat('png'));
            document.getElementById('formatJpeg').addEventListener('click', () => selectFormat('jpeg'));
            document.getElementById('qualitySlider').addEventListener('input', updateQuality);
            document.getElementById('downloadImageBtn').addEventListener('click', downloadImage);
            document.getElementById('copyImageBtn').addEventListener('click', copyImageToClipboard);
            document.getElementById('cancelImageBtn').addEventListener('click', cancelImageOptions);
            
            showStatus('DSR Form loaded successfully. Ready to generate reports.', 'success');
        });

        // Function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Function to generate preview HTML
        function generatePreviewHTML() {
            const reportDate = document.getElementById('reportDate').value;
            const quarterName = document.getElementById('quarterName').value;
            const supervisorName = document.getElementById('supervisorName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            return `
                <div id="dsrContentForImage" style="font-family: Arial, sans-serif; line-height: 1.5; max-width: 800px; margin: 0 auto; padding: 30px; background-color: white; box-shadow: 0 0 20px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="font-weight: bold; font-size: 24px; color: #2c3e50; margin-bottom: 5px;">
                            DAILY DSR REPORT
                        </div>
                        <div style="font-size: 20px; color: #3498db; margin-bottom: 5px;">
                            ${formatDate(reportDate)}
                        </div>
                        <div style="font-size: 22px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">
                            ${quarterName}
                        </div>
                        <div style="font-size: 18px; color: #34495e;">
                            ${supervisorName} | Phone: ${phoneNumber}
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 25px; font-size: 14px; border: 2px solid #2c3e50;">
                        <thead>
                            <tr style="background-color: #2c3e50; color: white;">
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: left; width: 10%;">S.No</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: left; width: 60%;">PARTICULARS</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: left; width: 30%;">DETAILS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dsrItems.map((item, index) => {
                                const inputValue = document.getElementById(`item-${item.id}`).value;
                                const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                                return `
                                    <tr style="background-color: ${rowColor};">
                                        <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold; text-align: center;">${item.id}</td>
                                        <td style="border: 1px solid #ddd; padding: 10px;">${item.particulars}</td>
                                        <td style="border: 1px solid #ddd; padding: 10px; font-weight: ${inputValue === 'Nil' ? 'normal' : 'bold'}; color: ${inputValue === 'Nil' ? '#666' : '#2c3e50'};">${inputValue}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; font-size: 12px; color: #7f8c8d; text-align: center;">
                        <div>Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        <div style="margin-top: 5px;">Daily Service Report - Quarters Management System</div>
                    </div>
                </div>
            `;
        }

        // Function to preview the DSR
        function previewDSR() {
            const previewHTML = generatePreviewHTML();
            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewContainer').style.display = 'block';
            
            // Hide image options container if visible
            document.getElementById('imageOptionsContainer').style.display = 'none';
            
            // Scroll to preview
            document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
            
            showStatus('DSR preview generated. Scroll down to view.', 'success');
        }

        // Function to generate PDF
        function generatePDF() {
            try {
                showStatus('Generating PDF...', 'info');
                
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('PDF library not loaded. Please check your internet connection.');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const reportDate = document.getElementById('reportDate').value;
                const quarterName = document.getElementById('quarterName').value;
                const supervisorName = document.getElementById('supervisorName').value;
                const phoneNumber = document.getElementById('phoneNumber').value;
                
                // Add title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("[DAILY DSR] " + formatDate(reportDate), 105, 20, { align: 'center' });
                
                // Add quarter name
                doc.setFontSize(14);
                doc.text(quarterName, 105, 30, { align: 'center' });
                
                // Add supervisor info
                doc.setFontSize(12);
                doc.text(supervisorName + ". Ph. No: " + phoneNumber, 105, 40, { align: 'center' });
                
                // Prepare table data
                const tableData = [];
                dsrItems.forEach(item => {
                    const inputValue = document.getElementById(`item-${item.id}`).value;
                    tableData.push([item.id.toString(), item.particulars, inputValue]);
                });
                
                // Generate table using autoTable plugin
                doc.autoTable({
                    startY: 50,
                    head: [['S.No', 'PARTICULARS', 'DETAILS']],
                    body: tableData,
                    headStyles: { 
                        fillColor: [44, 62, 80],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    styles: { 
                        fontSize: 10, 
                        cellPadding: 5,
                        overflow: 'linebreak'
                    },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' },
                        1: { cellWidth: 120 },
                        2: { cellWidth: 55 }
                    },
                    margin: { left: 10, right: 10 },
                    theme: 'grid'
                });
                
                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(
                        `Generated on: ${new Date().toLocaleDateString()}`, 
                        10, 
                        doc.internal.pageSize.height - 10
                    );
                }
                
                // Save the PDF
                const fileName = `DSR_${quarterName.replace(/\s+/g, '_')}_${formatDate(reportDate).replace(/\//g, '-')}.pdf`;
                doc.save(fileName);
                
                showStatus('PDF generated and downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showStatus(`Error generating PDF: ${error.message}.`, 'error');
            }
        }

        // Function to generate image
        async function generateImage() {
            try {
                showStatus('Generating image...', 'info');
                
                // Show loading indicator
                document.getElementById('imageLoading').style.display = 'block';
                document.getElementById('imagePreview').innerHTML = '';
                
                // Show the image options container
                document.getElementById('imageOptionsContainer').style.display = 'block';
                document.getElementById('imageOptionsContainer').scrollIntoView({ behavior: 'smooth' });
                
                // Hide preview container
                document.getElementById('previewContainer').style.display = 'none';
                
                // Generate image using html2canvas
                const imageData = await createDSRImage();
                currentImageData = imageData;
                
                // Create and display the image
                const img = document.createElement('img');
                img.src = currentImageData;
                img.alt = 'DSR Report Image';
                img.style.width = '100%';
                img.style.height = 'auto';
                img.style.display = 'block';
                
                // Clear loading and add image
                document.getElementById('imageLoading').style.display = 'none';
                document.getElementById('imagePreview').appendChild(img);
                
                showStatus('Image generated successfully! Choose format and download.', 'success');
                
            } catch (error) {
                console.error('Image generation error:', error);
                
                // Hide loading
                document.getElementById('imageLoading').style.display = 'none';
                
                // Show error message
                document.getElementById('imagePreview').innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>Failed to generate image</h3>
                        <p>${error.message || 'Unknown error occurred'}</p>
                    </div>
                `;
                
                showStatus(`Error: ${error.message}. Try PDF option instead.`, 'error');
            }
        }

        // Function to create DSR image
        async function createDSRImage() {
            return new Promise((resolve, reject) => {
                try {
                    // Create a temporary container
                    const container = document.createElement('div');
                    container.style.position = 'fixed';
                    container.style.left = '-9999px';
                    container.style.top = '0';
                    container.style.width = '800px';
                    container.style.backgroundColor = 'white';
                    container.style.padding = '20px';
                    container.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
                    
                    // Create the content
                    const reportDate = document.getElementById('reportDate').value;
                    const quarterName = document.getElementById('quarterName').value;
                    const supervisorName = document.getElementById('supervisorName').value;
                    const phoneNumber = document.getElementById('phoneNumber').value;
                    
                    const contentHTML = `
                        <div style="font-family: Arial, sans-serif; line-height: 1.5; width: 100%;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-weight: bold; font-size: 22px; color: #2c3e50; margin-bottom: 5px;">
                                    DAILY DSR REPORT
                                </div>
                                <div style="font-size: 18px; color: #3498db; margin-bottom: 5px;">
                                    ${formatDate(reportDate)}
                                </div>
                                <div style="font-size: 20px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">
                                    ${quarterName}
                                </div>
                                <div style="font-size: 16px; color: #34495e;">
                                    ${supervisorName} | Phone: ${phoneNumber}
                                </div>
                            </div>
                            
                            <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; border: 1px solid #2c3e50;">
                                <thead>
                                    <tr style="background-color: #2c3e50; color: white;">
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">S.No</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">PARTICULARS</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">DETAILS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dsrItems.map((item, index) => {
                                        const inputValue = document.getElementById(`item-${item.id}`).value;
                                        const rowColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                                        return `
                                            <tr style="background-color: ${rowColor};">
                                                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; text-align: center;">${item.id}</td>
                                                <td style="border: 1px solid #ddd; padding: 8px;">${item.particulars}</td>
                                                <td style="border: 1px solid #ddd; padding: 8px;">${inputValue}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            
                            <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; font-size: 11px; color: #7f8c8d; text-align: center;">
                                Generated on: ${new Date().toLocaleDateString()}
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML = contentHTML;
                    document.body.appendChild(container);
                    
                    // Use html2canvas
                    html2canvas(container, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        logging: false
                    }).then(canvas => {
                        const imageData = canvas.toDataURL('image/png', 0.9);
                        document.body.removeChild(container);
                        resolve(imageData);
                    }).catch(error => {
                        document.body.removeChild(container);
                        reject(error);
                    });
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Function to select image format
        function selectFormat(format) {
            currentImageFormat = format;
            
            // Update UI
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById(`format${format.charAt(0).toUpperCase() + format.slice(1)}`).classList.add('selected');
            
            // Show/hide quality options for JPEG
            if (format === 'jpeg') {
                document.getElementById('qualityOptions').style.display = 'flex';
            } else {
                document.getElementById('qualityOptions').style.display = 'none';
            }
            
            // Regenerate image with new format if we have existing image
            if (currentImageData) {
                regenerateImage();
            }
        }

        // Function to update image quality
        function updateQuality() {
            const qualityValue = document.getElementById('qualitySlider').value;
            document.getElementById('qualityValue').textContent = qualityValue;
            currentImageQuality = qualityValue / 100;
            
            // Regenerate image with new quality (for JPEG)
            if (currentImageFormat === 'jpeg' && currentImageData) {
                regenerateImage();
            }
        }

        // Function to regenerate image with current settings
        function regenerateImage() {
            if (!currentImageData) return;
            
            try {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    currentImageData = canvas.toDataURL(`image/${currentImageFormat}`, currentImageQuality);
                    
                    const previewImg = document.querySelector('#imagePreview img');
                    if (previewImg) {
                        previewImg.src = currentImageData;
                    }
                    
                    showStatus(`Image updated to ${currentImageFormat.toUpperCase()} format${currentImageFormat === 'jpeg' ? ` (Quality: ${currentImageQuality * 100}%)` : ''}`, 'info');
                };
                img.src = currentImageData;
            } catch (error) {
                console.error('Error regenerating image:', error);
                showStatus('Error updating image format.', 'error');
            }
        }

        // Function to download the image
        function downloadImage() {
            if (!currentImageData) {
                showStatus('No image available to download.', 'error');
                return;
            }
            
            const reportDate = document.getElementById('reportDate').value;
            const quarterName = document.getElementById('quarterName').value;
            
            const link = document.createElement('a');
            link.href = currentImageData;
            link.download = `DSR_${quarterName.replace(/\s+/g, '_')}_${formatDate(reportDate).replace(/\//g, '-')}.${currentImageFormat}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus(`Image downloaded as ${currentImageFormat.toUpperCase()}!`, 'success');
        }

        // Function to copy image to clipboard
        async function copyImageToClipboard() {
            if (!currentImageData) {
                showStatus('No image available to copy.', 'error');
                return;
            }
            
            try {
                const response = await fetch(currentImageData);
                const blob = await response.blob();
                
                await navigator.clipboard.write([
                    new ClipboardItem({
                        [blob.type]: blob
                    })
                ]);
                
                showStatus('Image copied to clipboard!', 'success');
            } catch (error) {
                console.error('Error copying image:', error);
                showStatus('Could not copy image to clipboard.', 'error');
            }
        }

        // Function to cancel image options
        function cancelImageOptions() {
            document.getElementById('imageOptionsContainer').style.display = 'none';
            showStatus('Image options closed.', 'info');
        }

        // Function to reset the form
        function resetForm() {
            if (confirm('Are you sure you want to reset all fields?')) {
                document.getElementById('reportDate').value = '2025-02-12';
                document.getElementById('quarterName').value = 'LUTHARAL GARDEN AR QUARTER NEW';
                document.getElementById('supervisorName').value = 'G.MATHIYAZHAGAN. SSI.';
                document.getElementById('phoneNumber').value = '+9841396946';
                
                // Reset all DSR item inputs to their default values
                dsrItems.forEach(item => {
                    document.getElementById(`item-${item.id}`).value = item.details;
                });
                
                // Hide all containers
                document.getElementById('previewContainer').style.display = 'none';
                document.getElementById('imageOptionsContainer').style.display = 'none';
                document.getElementById('statusMessage').style.display = 'none';
                
                showStatus('Form has been reset to default values.', 'success');
            }
        }

        // Function to print the preview
        function printPreview() {
            const printContent = document.getElementById('previewContent').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daily DSR Print</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            line-height: 1.5; 
                            padding: 20px; 
                            margin: 0;
                        }
                        @media print {
                            body { padding: 10px; }
                            @page { margin: 0.5cm; }
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 20px; 
                        }
                        th, td { 
                            border: 1px solid #000; 
                            padding: 8px; 
                            text-align: left; 
                            font-size: 12px;
                        }
                        th { 
                            background-color: #f2f2f2; 
                            font-weight: bold;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 20px; 
                        }
                        .footer {
                            margin-top: 30px;
                            font-size: 10px;
                            text-align: center;
                            color: #666;
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <div class="footer">
                        Printed on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }
    </script>
</body>
</html>
