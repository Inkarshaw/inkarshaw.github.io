<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Quiz Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            transition: transform 0.3s, box-shadow 0.3s;
            border: none;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .card-img-top {
            height: 150px;
            object-fit: cover;
        }
        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }
        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2e59d9;
        }
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .option {
            text-align: left;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .option:hover:not(.selected) {
            background-color: #f8f9fa;
        }
        .selected {
            background-color: #4e73df;
            color: white;
        }
        .progress {
            height: 10px;
            margin-bottom: 20px;
        }
        #loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .difficulty-badge {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
        }
        .easy {
            background-color: #28a745;
            color: white;
        }
        .medium {
            background-color: #ffc107;
            color: black;
        }
        .hard {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <!-- Loading Indicator -->
        <div id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading quiz data...</p>
        </div>

        <!-- Topic Selection -->
        <div id="topic-selection" class="text-center">
            <h1 class="mb-4">Welcome to QuizMaster</h1>
            <p class="lead mb-5">Select a topic to begin your quiz</p>
            <div class="row g-4" id="topics-container"></div>
        </div>
        
        <!-- Subtopic Selection -->
        <div id="subtopic-selection" class="text-center d-none">
            <h2 id="subtopic-heading" class="mb-4">Select a Subtopic</h2>
            <button class="btn btn-secondary mb-4" id="back-to-topics">
                <i class="bi bi-arrow-left"></i> Back to Topics
            </button>
            <div class="row g-4" id="subtopics-container"></div>
        </div>
        
        <!-- Quiz Area -->
        <div id="quiz-area" class="d-none">
            <div class="quiz-container">
                <button class="btn btn-secondary mb-3" id="back-to-subtopics">
                    <i class="bi bi-arrow-left"></i> Back to Subtopics
                </button>
                
                <div class="progress">
                    <div id="quiz-progress" class="progress-bar" role="progressbar"></div>
                </div>
                
                <div id="question-container" class="mb-4"></div>
                <div id="options-container" class="my-4"></div>
                
                <div class="d-flex justify-content-between">
                    <div id="question-counter" class="text-muted"></div>
                    <button id="submit-answer" class="btn btn-primary">Submit Answer</button>
                </div>
                
                <div id="result" class="mt-4"></div>
                <div id="score" class="mt-3 fw-bold"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    
    <script>
        // Configuration
        const SPREADSHEET_ID = '1RO-RgSm1UHFcv_tWT_CgIFS_scY5CBRsE3CR3zZa9Ws';
        const TOPICS_RANGE = 'Topics!A2:D';
        const SUBTOPICS_RANGE = 'Subtopics!A2:E';
        const QUESTIONS_RANGE = 'Questions!A2:I';
        
        // For production, replace with your actual API key or use a backend
        const API_KEY = 'AIzaSyDSSOLAHKjToG09cmCPzXurnKqLWOlJurE'; // This is a sample invalid key - replace with yours

        // DOM Elements
        const topicSelection = document.getElementById('topic-selection');
        const subtopicSelection = document.getElementById('subtopic-selection');
        const quizArea = document.getElementById('quiz-area');
        const topicsContainer = document.getElementById('topics-container');
        const subtopicsContainer = document.getElementById('subtopics-container');
        const questionContainer = document.getElementById('question-container');
        const optionsContainer = document.getElementById('options-container');
        const loadingIndicator = document.getElementById('loading');
        const subtopicHeading = document.getElementById('subtopic-heading');

        // State
        let currentTopic = null;
        let currentSubtopic = null;
        let currentTopicName = '';
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedOption = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTopics();
            
            // Navigation handlers
            document.getElementById('back-to-topics').addEventListener('click', () => {
                subtopicSelection.classList.add('d-none');
                topicSelection.classList.remove('d-none');
            });
            
            document.getElementById('back-to-subtopics').addEventListener('click', () => {
                quizArea.classList.add('d-none');
                subtopicSelection.classList.remove('d-none');
                resetQuiz();
            });
            
            document.getElementById('submit-answer').addEventListener('click', checkAnswer);
        });

        async function loadTopics() {
            showLoading();
            const topics = await getSheetData(TOPICS_RANGE);
            hideLoading();
            
            if (!topics || topics.length === 0) {
                topicsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">No topics found. Please check the Google Sheet configuration.</div>
                    </div>
                `;
                return;
            }
            
            topicsContainer.innerHTML = '';
            
            topics.forEach(topic => {
                const [id, name, description, imageUrl] = topic;
                const topicCard = document.createElement('div');
                topicCard.className = 'col-md-4 col-sm-6';
                topicCard.innerHTML = `
                    <div class="card h-100">
                        <img src="${imageUrl || 'https://via.placeholder.com/300x150?text=Quiz+Topic'}" class="card-img-top" alt="${name}">
                        <div class="card-body">
                            <h5 class="card-title">${name}</h5>
                            <p class="card-text">${description || 'Test your knowledge on this topic'}</p>
                            <button class="btn btn-primary select-topic" data-id="${id}" data-name="${name}">
                                Select Topic <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                `;
                topicsContainer.appendChild(topicCard);
            });
            
            document.querySelectorAll('.select-topic').forEach(button => {
                button.addEventListener('click', async (e) => {
                    currentTopic = e.target.getAttribute('data-id');
                    currentTopicName = e.target.getAttribute('data-name');
                    await loadSubtopics(currentTopic);
                    topicSelection.classList.add('d-none');
                    subtopicSelection.classList.remove('d-none');
                    subtopicHeading.textContent = `${currentTopicName} - Select Subtopic`;
                });
            });
        }

        async function loadSubtopics(topicId) {
            showLoading();
            const allSubtopics = await getSheetData(SUBTOPICS_RANGE);
            hideLoading();
            
            const filteredSubtopics = allSubtopics.filter(st => st[1] === topicId);
            
            if (!filteredSubtopics || filteredSubtopics.length === 0) {
                subtopicsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">No subtopics found for this topic.</div>
                    </div>
                `;
                return;
            }
            
            subtopicsContainer.innerHTML = '';
            
            filteredSubtopics.forEach(subtopic => {
                const [id, _, name, description, difficulty] = subtopic;
                const difficultyClass = getDifficultyClass(difficulty);
                
                const subtopicCard = document.createElement('div');
                subtopicCard.className = 'col-md-6';
                subtopicCard.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${name}</h5>
                            <p class="card-text">${description || 'Test your knowledge on this subtopic'}</p>
                            <span class="difficulty-badge ${difficultyClass}">${difficulty || 'Unknown'} difficulty</span>
                            <button class="btn btn-primary mt-3 select-subtopic" data-id="${id}">
                                Start Quiz <i class="bi bi-play-fill"></i>
                            </button>
                        </div>
                    </div>
                `;
                subtopicsContainer.appendChild(subtopicCard);
            });
            
            document.querySelectorAll('.select-subtopic').forEach(button => {
                button.addEventListener('click', async (e) => {
                    currentSubtopic = e.target.getAttribute('data-id');
                    await loadQuestions(currentSubtopic);
                    subtopicSelection.classList.add('d-none');
                    quizArea.classList.remove('d-none');
                    displayQuestion();
                });
            });
        }

        function getDifficultyClass(difficulty) {
            if (!difficulty) return 'easy';
            const lowerCaseDiff = difficulty.toLowerCase();
            if (lowerCaseDiff.includes('easy')) return 'easy';
            if (lowerCaseDiff.includes('medium')) return 'medium';
            if (lowerCaseDiff.includes('hard')) return 'hard';
            return 'easy';
        }

        async function loadQuestions(subtopicId) {
            showLoading();
            const allQuestions = await getSheetData(QUESTIONS_RANGE);
            hideLoading();
            
            questions = allQuestions.filter(q => q[1] === subtopicId);
            
            if (!questions || questions.length === 0) {
                questionContainer.innerHTML = `
                    <div class="alert alert-danger">No questions found for this subtopic.</div>
                `;
                return;
            }
            
            // Shuffle questions if desired
            questions = shuffleArray(questions);
            currentQuestionIndex = 0;
            score = 0;
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endQuiz();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            const [_, __, questionText, opt1, opt2, opt3, opt4] = question;
            
            // Update progress bar
            const progressPercent = (currentQuestionIndex / questions.length) * 100;
            document.getElementById('quiz-progress').style.width = `${progressPercent}%`;
            document.getElementById('question-counter').textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
            
            questionContainer.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title">${questionText}</h3>
                    </div>
                </div>
            `;
            
            optionsContainer.innerHTML = '';
            
            // Shuffle options (but keep track of correct answer)
            const options = [
                { text: opt1, index: 0 },
                { text: opt2, index: 1 },
                { text: opt3, index: 2 },
                { text: opt4, index: 3 }
            ];
            const shuffledOptions = shuffleArray(options);
            
            shuffledOptions.forEach((option) => {
                const optionButton = document.createElement('button');
                optionButton.className = 'btn btn-outline-primary w-100 mb-2 option';
                optionButton.textContent = option.text;
                optionButton.dataset.index = option.index;
                optionsContainer.appendChild(optionButton);
            });
            
            document.getElementById('result').innerHTML = '';
            document.getElementById('score').innerHTML = `Current Score: ${score}/${questions.length}`;
            document.getElementById('submit-answer').disabled = true;
            
            document.querySelectorAll('.option').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.option').forEach(btn => {
                        btn.classList.remove('selected', 'btn-primary');
                        btn.classList.add('btn-outline-primary');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('selected', 'btn-primary');
                    document.getElementById('submit-answer').disabled = false;
                    selectedOption = parseInt(this.dataset.index);
                });
            });
        }

        function checkAnswer() {
            if (selectedOption === null) {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select an answer before submitting.</div>';
                return;
            }
            
            const correctIndex = parseInt(questions[currentQuestionIndex][7]) - 1; // Assuming correct answer is 1-4
            const resultDiv = document.getElementById('result');
            
            if (selectedOption === correctIndex) {
                resultDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle-fill"></i> Correct! Well done.</div>';
                score++;
            } else {
                const correctText = questions[currentQuestionIndex][correctIndex + 3];
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle-fill"></i> Incorrect. The correct answer was: ${correctText}
                    </div>
                    ${questions[currentQuestionIndex][8] ? `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill"></i> ${questions[currentQuestionIndex][8]}
                    </div>
                    ` : ''}
                `;
            }
            
            document.getElementById('score').innerHTML = `Current Score: ${score}/${questions.length}`;
            document.getElementById('submit-answer').disabled = true;
            
            setTimeout(() => {
                currentQuestionIndex++;
                selectedOption = null;
                displayQuestion();
            }, 2000);
        }

        function endQuiz() {
            const percentage = score / questions.length;
            const resultMessage = getPerformanceMessage(percentage);
            
            questionContainer.innerHTML = `
                <div class="card">
                    <div class="card-body text-center">
                        <h2 class="card-title"><i class="bi bi-trophy-fill text-warning"></i> Quiz Completed!</h2>
                        <div class="display-4 my-4">${score}/${questions.length}</div>
                        <div class="h4 mb-4">${Math.round(percentage * 100)}% Correct</div>
                        <p class="lead">${resultMessage}</p>
                        <button id="restart-quiz" class="btn btn-primary mt-3">
                            <i class="bi bi-arrow-repeat"></i> Try Again
                        </button>
                    </div>
                </div>
            `;
            
            optionsContainer.innerHTML = '';
            document.getElementById('submit-answer').classList.add('d-none');
            
            document.getElementById('restart-quiz').addEventListener('click', () => {
                currentQuestionIndex = 0;
                score = 0;
                displayQuestion();
                document.getElementById('submit-answer').classList.remove('d-none');
            });
            
            // Here you could save the score to Google Sheets
            // saveScore(currentSubtopic, score);
        }

        function getPerformanceMessage(percentage) {
            if (percentage >= 0.9) return "Excellent work! You've mastered this topic.";
            if (percentage >= 0.7) return "Good job! You have a solid understanding.";
            if (percentage >= 0.5) return "Not bad! Consider reviewing some areas.";
            return "Keep practicing! You'll improve with more study.";
        }

        function resetQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            selectedOption = null;
            document.getElementById('submit-answer').classList.remove('d-none');
        }

        // Helper function to fetch data from Google Sheets
        async function getSheetData(range) {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}`
                );
                const data = await response.json();
                return data.values || [];
            } catch (error) {
                console.error('Error fetching sheet data:', error);
                return null;
            }
        }

        function showLoading() {
            loadingIndicator.style.display = 'block';
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
    </script>
</body>
</html>