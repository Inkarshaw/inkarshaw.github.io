<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TNPSC Quiz Platform</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #4e73df;
      --primary-hover: #2e59d9;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --dark-color: #343a40;
      --light-color: #f8f9fa;
    }
    
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding-top: 60px;
    }
    
    .navbar {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      padding: 12px 20px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .menu-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      margin-right: 15px;
      transition: transform 0.2s;
    }
    
    .menu-btn:hover {
      transform: scale(1.1);
    }
    
    .app-title {
      color: white;
      font-weight: bold;
      font-size: 1.3rem;
      margin: 0;
      flex-grow: 1;
    }
    
    .user-info {
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card {
      transition: transform 0.3s, box-shadow 0.3s;
      border: none;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      height: 100%;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    
    .topic-card {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .topic-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.1);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .topic-card:hover::before {
      opacity: 1;
    }
    
    .topic-progress {
      height: 5px;
      background: rgba(255,255,255,0.3);
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }
    
    .topic-progress-bar {
      height: 100%;
      background: white;
      border-radius: 5px;
      transition: width 0.5s;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      font-weight: 500;
      border-radius: 8px;
      padding: 10px 20px;
      transition: all 0.3s;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-hover);
      border-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .quiz-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    
    .option {
      text-align: left;
      margin-bottom: 10px;
      transition: all 0.3s;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #dee2e6;
      display: flex;
      align-items: center;
    }
    
    .option:hover:not(.selected) {
      background-color: #f8f9fa;
      border-color: var(--primary-color);
      transform: translateX(5px);
    }
    
    .option-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      background: #e9ecef;
      border-radius: 50%;
      margin-right: 15px;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .selected .option-number {
      background: white;
      color: var(--primary-color);
    }
    
    .selected {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .correct {
      background-color: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }
    
    .incorrect {
      background-color: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }
    
    .progress {
      height: 10px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    
    #loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .timer {
      background-color: #f8f9fa;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      border: 2px solid var(--primary-color);
    }
    
    .result-card {
      text-align: center;
      padding: 30px;
    }
    
    .result-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }
    
    .score-display {
      font-size: 3rem;
      font-weight: bold;
      margin: 20px 0;
      color: var(--primary-color);
    }
    
    .performance-message {
      font-size: 1.2rem;
      margin-bottom: 20px;
    }
    
    .question-count-selector {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .question-count-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .question-count-btn {
      flex: 1;
      min-width: 60px;
    }
    
    #next-question {
      display: block;
      margin-top: 20px;
    }
    
    .question-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .question-nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .question-nav-btn:hover {
      transform: scale(1.1);
    }
    
    .answered {
      background-color: var(--success-color);
      color: white;
    }
    
    .unanswered {
      background-color: #e9ecef;
      color: var(--dark-color);
    }
    
    .marked {
      background-color: var(--warning-color);
      color: black;
    }
    
    .current {
      border: 3px solid var(--primary-color);
      transform: scale(1.1);
    }
    
    .answer-review {
      margin-top: 30px;
      text-align: left;
    }
    
    .answer-item {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    
    .correct-answer {
      color: var(--success-color);
      font-weight: bold;
    }
    
    .user-answer {
      font-weight: bold;
    }
    
    .correct .user-answer {
      color: var(--success-color);
    }
    
    .incorrect .user-answer {
      color: var(--danger-color);
    }
    
    .answer-options {
      margin-top: 10px;
      margin-bottom: 15px;
    }
    
    .answer-option {
      padding: 8px 12px;
      margin-bottom: 5px;
      border-radius: 5px;
      border: 1px solid #dee2e6;
    }
    
    .correct-option {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
    
    .user-selected {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    
    .user-correct {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
    
    .range-selector {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .range-inputs {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .range-input {
      width: 100px;
      text-align: center;
    }
    
    .range-info {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #6c757d;
    }
    
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary-color);
      margin: 10px 0;
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .quiz-mode-selector {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .mode-options {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .mode-btn {
      flex: 1;
      min-width: 120px;
      padding: 15px;
      text-align: center;
    }
    
    .mode-icon {
      font-size: 1.5rem;
      margin-bottom: 10px;
      display: block;
    }
    
    .achievement-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--warning-color);
      color: #000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.8rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .question-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .question-status {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
    }
    
    .status-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
    }
    
    .status-answered .status-color {
      background-color: var(--success-color);
    }
    
    .status-unanswered .status-color {
      background-color: #e9ecef;
    }
    
    .status-marked .status-color {
      background-color: var(--warning-color);
    }
    
    .status-current .status-color {
      background-color: var(--primary-color);
    }
    
    @media (max-width: 768px) {
      .quiz-container {
        padding: 20px;
      }
      
      .option {
        padding: 12px 15px;
      }
      
      .question-nav-btn {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
      }
      
      .range-inputs {
        flex-direction: column;
        gap: 10px;
      }
      
      .mode-options {
        flex-direction: column;
      }
      
      .dashboard-stats {
        grid-template-columns: 1fr;
      }
    }

    /* Loading placeholders */
    .loading-placeholder {
      position: relative;
      overflow: hidden;
      background-color: #e9ecef;
      border-radius: 4px;
    }

    .loading-placeholder::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
                  rgba(255,255,255,0) 0%, 
                  rgba(255,255,255,0.5) 50%, 
                  rgba(255,255,255,0) 100%);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .card.loading {
      min-height: 150px;
    }

    .topic-placeholder {
      height: 100px;
      margin-bottom: 10px;
    }

    /* Welcome section */
    .welcome-section {
      text-align: center;
      padding: 30px 0;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    
    .welcome-title {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .welcome-subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
    }
  </style>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MWBY9ZRY9D"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CCR153SQSY');
  </script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <button class="menu-btn" id="menuBtn">
      <i class="bi bi-list"></i>
    </button>
    <h1 class="app-title">TNPSC QuizMaster</h1>
    <div class="user-info">
      <span id="userName">Guest</span>
      <i class="bi bi-person-circle"></i>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container py-5">
    <!-- Loading Indicator -->
    <div id="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading quiz data...</p>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="text-center">
      <div class="welcome-section">
        <h1 class="welcome-title">Welcome to TNPSC QuizMaster</h1>
        <p class="welcome-subtitle">Your ultimate preparation platform for TNPSC exams</p>
      </div>
      
      <div class="dashboard-stats">
        <div class="stat-card">
          <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
          <div class="stat-value" id="completedQuizzes">0</div>
          <div class="stat-label">Quizzes Completed</div>
        </div>
        <div class="stat-card">
          <i class="bi bi-clock-fill text-primary" style="font-size: 2rem;"></i>
          <div class="stat-value" id="totalTime">0m</div>
          <div class="stat-label">Time Spent</div>
        </div>
        <div class="stat-card">
          <i class="bi bi-trophy-fill text-warning" style="font-size: 2rem;"></i>
          <div class="stat-value" id="averageScore">0%</div>
          <div class="stat-label">Average Score</div>
        </div>
        <div class="stat-card">
          <i class="bi bi-lightning-fill text-info" style="font-size: 2rem;"></i>
          <div class="stat-value" id="currentStreak">0</div>
          <div class="stat-label">Current Streak</div>
        </div>
      </div>
      
      <h2 class="mb-4">Select a topic to begin your quiz</h2>
      <div class="row g-4" id="topics-container">
        <!-- Loading placeholders -->
        <div class="col-md-4 col-sm-6">
          <div class="card h-100 loading">
            <div class="card-body d-flex flex-column">
              <div class="topic-placeholder loading-placeholder"></div>
              <div class="loading-placeholder" style="height: 24px; width: 80%; margin-bottom: 10px;"></div>
              <div class="loading-placeholder" style="height: 16px; width: 60%;"></div>
              <div class="loading-placeholder mt-auto" style="height: 38px; width: 100%;"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4 col-sm-6">
          <div class="card h-100 loading">
            <div class="card-body d-flex flex-column">
              <div class="topic-placeholder loading-placeholder"></div>
              <div class="loading-placeholder" style="height: 24px; width: 80%; margin-bottom: 10px;"></div>
              <div class="loading-placeholder" style="height: 16px; width: 60%;"></div>
              <div class="loading-placeholder mt-auto" style="height: 38px; width: 100%;"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4 col-sm-6">
          <div class="card h-100 loading">
            <div class="card-body d-flex flex-column">
              <div class="topic-placeholder loading-placeholder"></div>
              <div class="loading-placeholder" style="height: 24px; width: 80%; margin-bottom: 10px;"></div>
              <div class="loading-placeholder" style="height: 16px; width: 60%;"></div>
              <div class="loading-placeholder mt-auto" style="height: 38px; width: 100%;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Subtopic Selection -->
    <div id="subtopic-selection" class="text-center d-none">
      <h2 id="subtopic-heading" class="mb-4">Select a Subtopic</h2>
      <button class="btn btn-outline-secondary mb-4" id="back-to-topics">
        <i class="bi bi-arrow-left"></i> Back to Topics
      </button>
      <div class="row g-4" id="subtopics-container"></div>
    </div>
    
    <!-- Quiz Mode Selection -->
    <div id="quiz-mode-selection" class="text-center d-none">
      <h2 id="quiz-mode-heading" class="mb-4">Select Quiz Mode</h2>
      <button class="btn btn-outline-secondary mb-4" id="back-to-subtopics">
        <i class="bi bi-arrow-left"></i> Back to Subtopics
      </button>
      <div class="quiz-mode-selector">
        <p>Choose your preferred quiz mode:</p>
        <div class="mode-options">
          <button class="btn btn-outline-primary mode-btn" data-mode="practice">
            <i class="bi bi-pencil-square mode-icon"></i>
            Practice Mode
            <small class="d-block">Learn at your own pace</small>
          </button>
          <button class="btn btn-outline-primary mode-btn" data-mode="timed">
            <i class="bi bi-clock mode-icon"></i>
            Timed Mode
            <small class="d-block">Test your speed</small>
          </button>
          <button class="btn btn-outline-primary mode-btn" data-mode="exam">
            <i class="bi bi-file-earmark-text mode-icon"></i>
            Exam Mode
            <small class="d-block">Simulate real exam</small>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Question Count Selection -->
    <div id="question-count-selection" class="text-center d-none">
      <h2 id="question-count-heading" class="mb-4">Select Number of Questions</h2>
      <button class="btn btn-outline-secondary mb-4" id="back-to-modes">
        <i class="bi bi-arrow-left"></i> Back to Modes
      </button>
      <div class="question-count-selector">
        <p>How many questions would you like in your quiz?</p>
        <div class="question-count-options" id="question-count-options"></div>
      </div>
      
      <!-- Range Selection -->
      <div class="range-selector">
        <p>Or select a specific range of questions:</p>
        <div class="range-inputs">
          <div>
            <label for="range-from" class="form-label">From</label>
            <input type="number" class="form-control range-input" id="range-from" min="1" value="1">
          </div>
          <div>
            <label for="range-to" class="form-label">To</label>
            <input type="number" class="form-control range-input" id="range-to" min="1" value="10">
          </div>
          <div>
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-primary" id="apply-range">Apply Range</button>
          </div>
        </div>
        <div class="range-info" id="range-info">Total available questions: <span id="total-questions">0</span></div>
      </div>
    </div>
    
    <!-- Quiz Area -->
    <div id="quiz-area" class="d-none">
      <div class="quiz-container">
        <div class="quiz-header">
          <button class="btn btn-outline-secondary" id="back-to-count-selection">
            <i class="bi bi-arrow-left"></i> Back
          </button>
          <div class="timer" id="quiz-timer">00:00</div>
        </div>
        
        <div class="progress">
          <div id="quiz-progress" class="progress-bar" role="progressbar"></div>
        </div>
        
        <div class="question-status">
          <div class="status-item status-answered">
            <div class="status-color"></div>
            <span>Answered</span>
          </div>
          <div class="status-item status-unanswered">
            <div class="status-color"></div>
            <span>Unanswered</span>
          </div>
          <div class="status-item status-marked">
            <div class="status-color"></div>
            <span>Marked</span>
          </div>
          <div class="status-item status-current">
            <div class="status-color"></div>
            <span>Current</span>
          </div>
        </div>
        
        <div class="question-nav" id="question-navigation"></div>
        
        <div id="question-container" class="mb-4"></div>
        <div id="options-container" class="my-4"></div>
        
        <div class="question-actions">
          <button id="mark-question" class="btn btn-warning">
            <i class="bi bi-flag"></i> Mark for Review
          </button>
          <button id="clear-selection" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Clear Selection
          </button>
        </div>
        
        <button id="next-question" class="btn btn-primary w-100 mt-3" disabled>
          <i class="bi bi-arrow-right"></i> Next Question
        </button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const config = {
      googleSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSHZc4XKsA7NeFUs9YppeBSchqG01tWIzVrCnvbydr1t-qqUnd8RlOe-EypAn8m4trcvaQ0OR-4WzEN/pub?output=csv",
      corsProxyUrl: "https://api.allorigins.win/raw?url=",
      fallbackData: `Topics,Subtopics,Question,OptionA,OptionB,OptionC,OptionD,CorrectAnswer,Explanation
General Studies,Indian History,When did India gain independence?,1945,1947,1950,1935,B,India gained independence from British rule on August 15, 1947
General Studies,Indian Polity,Who is known as the Father of the Indian Constitution?,Mahatma Gandhi,Jawaharlal Nehru,B.R. Ambedkar,Sardar Patel,C,Dr. B.R. Ambedkar was the chairman of the drafting committee of the Indian Constitution
General Studies,Geography,Which is the longest river in India?,Yamuna,Ganga,Brahmaputra,Godavari,B,The Ganga is the longest river in India with a length of 2,525 km
General Studies,Economics,What does GDP stand for?,Gross Domestic Product,General Domestic Product,Gross Development Product,General Development Product,A,GDP stands for Gross Domestic Product which measures the economic performance of a country
General Studies,Science,What is the chemical symbol for gold?,Ag,Au,Fe,Go,B,The chemical symbol for gold is Au from the Latin word 'aurum'
Aptitude,Verbal Reasoning,If all Zips are Zaps and some Zaps are Zops, then:,All Zips are Zops,Some Zips are Zops,No Zips are Zops,Some Zops are Zips,B,This is a logical reasoning question based on set theory
Aptitude,Quantitative Aptitude,What is 15% of 200?,15,30,20,25,B,15% of 200 = (15/100) × 200 = 30
Aptitude,Logical Reasoning,Complete the series: 2, 6, 12, 20, ?,42,30,36,32,B,The pattern is: 1×2=2, 2×3=6, 3×4=12, 4×5=20, 5×6=30
General Tamil,Grammar,Which is the correct plural form of 'புத்தகம்'?,புத்தகங்கள்,புத்தகங்கள்,புத்தகங்கள்,புத்தகங்கள்,A,The correct plural form of 'புத்தகம்' is 'புத்தகங்கள்'
General English,Grammar,Choose the correct sentence:,She don't like apples.,She doesn't like apples.,She doesn't likes apples.,She don't likes apples.,B,"The correct form is 'She doesn't like apples.' as 'doesn't' is used with third person singular"`,
      questionCountOptions: [5, 10, 15, 20, 25],
      quizModes: {
        PRACTICE: 'practice',
        TIMED: 'timed',
        EXAM: 'exam'
      }
    };

    // DOM Elements
    const dashboard = document.getElementById('dashboard');
    const topicSelection = document.getElementById('topic-selection');
    const subtopicSelection = document.getElementById('subtopic-selection');
    const quizModeSelection = document.getElementById('quiz-mode-selection');
    const questionCountSelection = document.getElementById('question-count-selection');
    const quizArea = document.getElementById('quiz-area');
    const topicsContainer = document.getElementById('topics-container');
    const subtopicsContainer = document.getElementById('subtopics-container');
    const questionCountOptions = document.getElementById('question-count-options');
    const questionContainer = document.getElementById('question-container');
    const optionsContainer = document.getElementById('options-container');
    const loadingIndicator = document.getElementById('loading');
    const subtopicHeading = document.getElementById('subtopic-heading');
    const quizModeHeading = document.getElementById('quiz-mode-heading');
    const questionCountHeading = document.getElementById('question-count-heading');
    const quizTimer = document.getElementById('quiz-timer');
    const nextQuestionBtn = document.getElementById('next-question');
    const questionNavigation = document.getElementById('question-navigation');
    const menuBtn = document.getElementById('menuBtn');
    const rangeFromInput = document.getElementById('range-from');
    const rangeToInput = document.getElementById('range-to');
    const applyRangeBtn = document.getElementById('apply-range');
    const rangeInfo = document.getElementById('range-info');
    const totalQuestionsSpan = document.getElementById('total-questions');
    const markQuestionBtn = document.getElementById('mark-question');
    const clearSelectionBtn = document.getElementById('clear-selection');
    const userName = document.getElementById('userName');
    const completedQuizzes = document.getElementById('completedQuizzes');
    const totalTime = document.getElementById('totalTime');
    const averageScore = document.getElementById('averageScore');
    const currentStreak = document.getElementById('currentStreak');

    // State
    let quizData = [];
    let currentTopic = null;
    let currentSubtopic = null;
    let currentTopicName = '';
    let selectedQuestionCount = 10;
    let availableQuestions = [];
    let quizQuestions = [];
    let currentQuestionIndex = 0;
    let selectedOption = null;
    let timerInterval = null;
    let secondsElapsed = 0;
    let quizStartTime = null;
    let userAnswers = [];
    let markedQuestions = [];
    let useRangeSelection = false;
    let rangeFrom = 1;
    let rangeTo = 10;
    let quizMode = config.quizModes.PRACTICE;
    let userStats = {
      completedQuizzes: 0,
      totalTime: 0,
      totalScore: 0,
      currentStreak: 0,
      bestStreak: 0,
      topicProgress: {}
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadQuizData();
      loadUserStats();
      updateDashboard();
      
      // Navigation handlers
      document.getElementById('back-to-topics').addEventListener('click', () => {
        subtopicSelection.classList.add('d-none');
        dashboard.classList.remove('d-none');
        resetQuizState();
      });
      
      document.getElementById('back-to-subtopics').addEventListener('click', () => {
        quizModeSelection.classList.add('d-none');
        subtopicSelection.classList.remove('d-none');
      });
      
      document.getElementById('back-to-modes').addEventListener('click', () => {
        questionCountSelection.classList.add('d-none');
        quizModeSelection.classList.remove('d-none');
      });
      
      document.getElementById('back-to-count-selection').addEventListener('click', () => {
        quizArea.classList.add('d-none');
        questionCountSelection.classList.remove('d-none');
        resetQuizState();
      });
      
      nextQuestionBtn.addEventListener('click', nextQuestion);
      markQuestionBtn.addEventListener('click', toggleMarkQuestion);
      clearSelectionBtn.addEventListener('click', clearSelection);
      
      // Range selection handler
      applyRangeBtn.addEventListener('click', applyRangeSelection);
      
      // Range input validation
      rangeFromInput.addEventListener('change', validateRangeInputs);
      rangeToInput.addEventListener('change', validateRangeInputs);
      
      // Menu button handler
      menuBtn.addEventListener('click', () => {
        alert("User profile and settings will be available in future updates");
      });
      
      // Quiz mode selection
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          quizMode = e.currentTarget.dataset.mode;
          quizModeSelection.classList.add('d-none');
          questionCountSelection.classList.remove('d-none');
          questionCountHeading.textContent = `${currentTopicName} - ${currentSubtopic} - Select Question Count`;
        });
      });
    });

    async function loadQuizData() {
      showLoading();
      
      try {
        // First try local cache with timestamp check
        const cachedData = localStorage.getItem('quizData');
        const lastUpdated = localStorage.getItem('quizDataLastUpdated');
        
        // Only use cache if it's less than 24 hours old
        if (cachedData && lastUpdated && (Date.now() - parseInt(lastUpdated)) < 86400000) {
          processQuizData(cachedData);
          hideLoading();
          return true;
        }
        
        // Try network with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
        
        const response = await fetch(`${config.corsProxyUrl}${encodeURIComponent(config.googleSheetUrl)}`, {
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error('Network response was not ok');
        
        const csv = await response.text();
        processQuizData(csv);
        
        // Cache the data with timestamp
        localStorage.setItem('quizData', csv);
        localStorage.setItem('quizDataLastUpdated', Date.now());
        
      } catch (error) {
        console.error("Error loading quiz data:", error);
        
        // Fallback to any cached data even if stale
        const cachedData = localStorage.getItem('quizData');
        if (cachedData) {
          processQuizData(cachedData);
          showMessage("Using cached data (connection issue)", 'warning');
        } 
        // Fallback to built-in data
        else {
          processQuizData(config.fallbackData);
          showMessage("Using sample data (connection issue)", 'warning');
        }
      } finally {
        hideLoading();
      }
      return true;
    }

    function processQuizData(csv) {
      const rows = parseCSV(csv);
      const headers = rows[0].map(header => header.trim().toLowerCase());
      
      // Verify required columns exist
      const requiredColumns = ['topics', 'subtopics', 'question', 'optiona', 'optionb', 'optionc', 'optiond', 'correctanswer'];
      requiredColumns.forEach(col => {
        if (!headers.includes(col)) {
          throw new Error(`Missing required column: ${col}`);
        }
      });
      
      quizData = rows.slice(1)
        .map(row => {
          const question = {};
          headers.forEach((header, index) => {
            question[header] = (row[index] || '').trim();
          });
          // Convert correct answer to uppercase for consistency
          if (question.correctanswer) {
            question.correctanswer = question.correctanswer.toUpperCase();
          }
          return question;
        })
        .filter(q => q.topics && q.subtopics && q.question);
      
      if (quizData.length === 0) {
        throw new Error('No valid questions found in the data');
      }
      
      populateTopics();
      setupQuestionCountOptions();
    }

    function parseCSV(csv) {
      const rows = [];
      let currentRow = [''];
      let inQuotes = false;
      
      for (let i = 0; i < csv.length; i++) {
        const char = csv[i];
        const nextChar = csv[i + 1];
        
        if (char === '"' && nextChar === '"' && inQuotes) {
          currentRow[currentRow.length - 1] += '"';
          i++; // Skip next quote
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          currentRow.push('');
        } else if (char === '\n' && !inQuotes) {
          rows.push(currentRow);
          currentRow = [''];
        } else {
          currentRow[currentRow.length - 1] += char;
        }
      }
      
      // Add the last row
      rows.push(currentRow);
      
      return rows;
    }

    function populateTopics() {
      // Get unique topics
      const topics = [...new Set(quizData.map(q => q.topics))].sort();
      
      if (!topics || topics.length === 0) {
        topicsContainer.innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">No topics found in the quiz data.</div>
          </div>
        `;
        return;
      }
      
      topicsContainer.innerHTML = '';
      
      topics.forEach(topic => {
        const topicQuestions = quizData.filter(q => q.topics === topic);
        const subtopics = [...new Set(topicQuestions.map(q => q.subtopics))];
        const progress = calculateTopicProgress(topic);
        
        const topicCard = document.createElement('div');
        topicCard.className = 'col-md-4 col-sm-6';
        topicCard.innerHTML = `
          <div class="card topic-card h-100">
            <div class="card-body d-flex flex-column position-relative">
              ${progress >= 80 ? '<div class="achievement-badge"><i class="bi bi-trophy"></i></div>' : ''}
              <h5 class="card-title">${topic}</h5>
              <p class="card-text">${subtopics.length} subtopics • ${topicQuestions.length} questions</p>
              <div class="topic-progress">
                <div class="topic-progress-bar" style="width: ${progress}%"></div>
              </div>
              <div class="mt-auto">
                <button class="btn btn-light mt-3 w-100 select-topic" data-topic="${topic}">
                  Start Quiz <i class="bi bi-play-fill"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        topicsContainer.appendChild(topicCard);
      });
      
      document.querySelectorAll('.select-topic').forEach(button => {
        button.addEventListener('click', async (e) => {
          currentTopic = e.target.getAttribute('data-topic');
          currentTopicName = currentTopic;
          await loadSubtopics(currentTopic);
          dashboard.classList.add('d-none');
          subtopicSelection.classList.remove('d-none');
          subtopicHeading.textContent = `${currentTopicName} - Select Subtopic`;
        });
      });
    }

    function calculateTopicProgress(topic) {
      if (!userStats.topicProgress[topic]) return 0;
      const progress = userStats.topicProgress[topic];
      const totalQuestions = quizData.filter(q => q.topics === topic).length;
      const answeredQuestions = progress.answered || 0;
      return Math.min(100, Math.round((answeredQuestions / totalQuestions) * 100));
    }

    function setupQuestionCountOptions() {
      questionCountOptions.innerHTML = '';
      
      config.questionCountOptions.forEach(count => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary question-count-btn';
        btn.textContent = count;
        btn.dataset.count = count;
        questionCountOptions.appendChild(btn);
      });
      
      document.querySelectorAll('.question-count-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          useRangeSelection = false;
          selectedQuestionCount = parseInt(e.target.dataset.count);
          prepareQuizQuestions();
          questionCountSelection.classList.add('d-none');
          quizArea.classList.remove('d-none');
          startQuiz();
        });
      });
    }

    async function loadSubtopics(topic) {
      showLoading();
      
      // Get unique subtopics for this topic
      const subtopics = [...new Set(
        quizData.filter(q => q.topics === topic).map(q => q.subtopics)
      )].sort();
      
      hideLoading();
      
      if (!subtopics || subtopics.length === 0) {
        subtopicsContainer.innerHTML = `
          <div class="col-12">
            <div class="alert alert-warning">No subtopics found for this topic.</div>
          </div>
        `;
        return;
      }
      
      subtopicsContainer.innerHTML = '';
      
      subtopics.forEach(subtopic => {
        const subtopicQuestions = quizData.filter(q => 
          q.topics === topic && q.subtopics === subtopic
        );
        
        const subtopicCard = document.createElement('div');
        subtopicCard.className = 'col-md-6';
        subtopicCard.innerHTML = `
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${subtopic}</h5>
              <p class="card-text">${subtopicQuestions.length} questions available</p>
              <div class="mt-auto">
                <button class="btn btn-primary mt-3 w-100 select-subtopic" data-topic="${topic}" data-subtopic="${subtopic}">
                  Select <i class="bi bi-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        subtopicsContainer.appendChild(subtopicCard);
      });
      
      document.querySelectorAll('.select-subtopic').forEach(button => {
        button.addEventListener('click', async (e) => {
          currentTopic = e.target.getAttribute('data-topic');
          currentSubtopic = e.target.getAttribute('data-subtopic');
          await loadQuestions(currentTopic, currentSubtopic);
          subtopicSelection.classList.add('d-none');
          quizModeSelection.classList.remove('d-none');
          quizModeHeading.textContent = `${currentTopicName} - ${currentSubtopic} - Select Quiz Mode`;
        });
      });
    }

    async function loadQuestions(topic, subtopic) {
      showLoading();
      
      availableQuestions = quizData.filter(q => 
        q.topics === topic && 
        q.subtopics === subtopic
      );
      
      // Update range inputs based on available questions
      rangeFromInput.value = 1;
      rangeToInput.value = Math.min(10, availableQuestions.length);
      rangeFromInput.max = availableQuestions.length;
      rangeToInput.max = availableQuestions.length;
      totalQuestionsSpan.textContent = availableQuestions.length;
      
      hideLoading();
      
      if (!availableQuestions || availableQuestions.length === 0) {
        questionContainer.innerHTML = `
          <div class="alert alert-danger">No questions found for this subtopic.</div>
        `;
        return;
      }
    }

    function applyRangeSelection() {
      rangeFrom = parseInt(rangeFromInput.value);
      rangeTo = parseInt(rangeToInput.value);
      
      if (validateRangeInputs()) {
        useRangeSelection = true;
        prepareQuizQuestions();
        questionCountSelection.classList.add('d-none');
        quizArea.classList.remove('d-none');
        startQuiz();
      }
    }

    function validateRangeInputs() {
      const from = parseInt(rangeFromInput.value);
      const to = parseInt(rangeToInput.value);
      const maxQuestions = availableQuestions.length;
      
      if (isNaN(from) || isNaN(to)) {
        showMessage("Please enter valid numbers for the range", "danger");
        return false;
      }
      
      if (from < 1) {
        rangeFromInput.value = 1;
        showMessage("Starting question cannot be less than 1", "warning");
        return false;
      }
      
      if (to > maxQuestions) {
        rangeToInput.value = maxQuestions;
        showMessage(`Ending question cannot be more than ${maxQuestions}`, "warning");
        return false;
      }
      
      if (from > to) {
        rangeFromInput.value = to;
        showMessage("Starting question cannot be greater than ending question", "warning");
        return false;
      }
      
      return true;
    }

    function prepareQuizQuestions() {
      if (useRangeSelection) {
        // Use the selected range
        const startIndex = rangeFrom - 1; // Convert to 0-based index
        const endIndex = rangeTo; // Convert to 0-based index (exclusive)
        quizQuestions = availableQuestions.slice(startIndex, endIndex);
        selectedQuestionCount = quizQuestions.length;
      } else {
        // Use random selection (original behavior)
        const shuffledQuestions = shuffleArray([...availableQuestions]);
        quizQuestions = shuffledQuestions.slice(0, Math.min(selectedQuestionCount, shuffledQuestions.length));
      }
      
      currentQuestionIndex = 0;
      secondsElapsed = 0;
      userAnswers = Array(quizQuestions.length).fill(null);
      markedQuestions = Array(quizQuestions.length).fill(false);
    }

    function startQuiz() {
      quizStartTime = new Date();
      
      // Set up timer based on quiz mode
      if (quizMode === config.quizModes.TIMED) {
        // 30 seconds per question
        secondsElapsed = selectedQuestionCount * 30;
        startCountdownTimer();
      } else if (quizMode === config.quizModes.EXAM) {
        // 1 minute per question
        secondsElapsed = selectedQuestionCount * 60;
        startCountdownTimer();
      } else {
        // Practice mode - count up
        startTimer();
      }
      
      displayQuestion();
      updateQuestionNavigation();
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      
      timerInterval = setInterval(() => {
        secondsElapsed++;
        updateTimerDisplay();
      }, 1000);
    }

    function startCountdownTimer() {
      if (timerInterval) clearInterval(timerInterval);
      
      timerInterval = setInterval(() => {
        secondsElapsed--;
        updateTimerDisplay();
        
        if (secondsElapsed <= 0) {
          clearInterval(timerInterval);
          endQuiz();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(Math.abs(secondsElapsed) / 60);
      const seconds = Math.abs(secondsElapsed) % 60;
      const sign = secondsElapsed < 0 ? '-' : '';
      quizTimer.textContent = `${sign}${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      // Change color when time is running out (for countdown)
      if (quizMode !== config.quizModes.PRACTICE && secondsElapsed < 60) {
        quizTimer.style.backgroundColor = '#f8d7da';
        quizTimer.style.borderColor = '#f5c6cb';
        quizTimer.style.color = '#721c24';
      } else {
        quizTimer.style.backgroundColor = '';
        quizTimer.style.borderColor = '';
        quizTimer.style.color = '';
      }
    }

    function updateQuestionNavigation() {
      questionNavigation.innerHTML = '';
      
      quizQuestions.forEach((_, index) => {
        const btn = document.createElement('button');
        let btnClass = `question-nav-btn`;
        
        if (userAnswers[index] !== null) {
          btnClass += ' answered';
        } else {
          btnClass += ' unanswered';
        }
        
        if (markedQuestions[index]) {
          btnClass += ' marked';
        }
        
        if (index === currentQuestionIndex) {
          btnClass += ' current';
        }
        
        // Show actual question numbers when using range selection
        if (useRangeSelection) {
          btn.textContent = rangeFrom + index;
        } else {
          btn.textContent = index + 1;
        }
        
        btn.className = btnClass;
        btn.addEventListener('click', () => {
          currentQuestionIndex = index;
          displayQuestion();
          updateQuestionNavigation();
        });
        questionNavigation.appendChild(btn);
      });
    }

    function displayQuestion() {
      nextQuestionBtn.disabled = true;
      
      if (currentQuestionIndex >= quizQuestions.length) {
        endQuiz();
        return;
      }
      
      const question = quizQuestions[currentQuestionIndex];
      
      // Update progress bar
      const progressPercent = (currentQuestionIndex / quizQuestions.length) * 100;
      document.getElementById('quiz-progress').style.width = `${progressPercent}%`;
      
      // Show question number with range info if applicable
      let questionNumber = currentQuestionIndex + 1;
      if (useRangeSelection) {
        questionNumber = rangeFrom + currentQuestionIndex;
      }
      
      questionContainer.innerHTML = `
        <div class="card">
          <div class="card-body">
            <h3 class="card-title">Question ${questionNumber}</h3>
            <p class="card-text fs-5">${question.question}</p>
          </div>
        </div>
      `;
      
      optionsContainer.innerHTML = '';
      
      // Create options
      const options = [
        { text: question.optiona, value: 'A' },
        { text: question.optionb, value: 'B' },
        { text: question.optionc, value: 'C' },
        { text: question.optiond, value: 'D' }
      ];
      
      options.forEach((option, index) => {
        if (option.text) { // Only show if option exists
          const optionElement = document.createElement('div');
          optionElement.className = 'option';
          optionElement.innerHTML = `
            <span class="option-number">${String.fromCharCode(65 + index)}</span>
            <span class="option-text">${option.text}</span>
          `;
          optionElement.dataset.value = option.value;
          
          // Check if this option was previously selected
          if (userAnswers[currentQuestionIndex] === option.value) {
            optionElement.classList.add('selected');
            nextQuestionBtn.disabled = false;
          }
          
          optionElement.addEventListener('click', () => selectOption(optionElement));
          optionsContainer.appendChild(optionElement);
        }
      });
      
      // Update mark button state
      markQuestionBtn.innerHTML = markedQuestions[currentQuestionIndex] ? 
        '<i class="bi bi-flag-fill"></i> Unmark' : 
        '<i class="bi bi-flag"></i> Mark for Review';
      
      updateQuestionNavigation();
    }

    function selectOption(optionElement) {
      // Remove selected class from all options
      document.querySelectorAll('.option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      // Add selected class to clicked option
      optionElement.classList.add('selected');
      selectedOption = optionElement.dataset.value;
      userAnswers[currentQuestionIndex] = selectedOption;
      nextQuestionBtn.disabled = false;
      
      updateQuestionNavigation();
    }

    function toggleMarkQuestion() {
      markedQuestions[currentQuestionIndex] = !markedQuestions[currentQuestionIndex];
      markQuestionBtn.innerHTML = markedQuestions[currentQuestionIndex] ? 
        '<i class="bi bi-flag-fill"></i> Unmark' : 
        '<i class="bi bi-flag"></i> Mark for Review';
      updateQuestionNavigation();
    }

    function clearSelection() {
      // Remove selected class from all options
      document.querySelectorAll('.option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      selectedOption = null;
      userAnswers[currentQuestionIndex] = null;
      nextQuestionBtn.disabled = true;
      
      updateQuestionNavigation();
    }

    function nextQuestion() {
      if (selectedOption === null && quizMode !== config.quizModes.PRACTICE) {
        // In timed/exam mode, allow moving to next question without answering
        if (currentQuestionIndex < quizQuestions.length - 1) {
          currentQuestionIndex++;
          selectedOption = null;
          displayQuestion();
        } else {
          endQuiz();
        }
        return;
      }
      
      currentQuestionIndex++;
      selectedOption = null;
      
      if (currentQuestionIndex < quizQuestions.length) {
        displayQuestion();
      } else {
        endQuiz();
      }
    }

    function endQuiz() {
      clearInterval(timerInterval);
      
      // Calculate score
      const score = userAnswers.reduce((total, answer, index) => {
        return total + (answer === quizQuestions[index].correctanswer ? 1 : 0);
      }, 0);
      
      const percentage = (score / quizQuestions.length) * 100;
      const resultMessage = getPerformanceMessage(percentage);
      const timeSpent = formatTime(Math.abs(secondsElapsed));
      
      // Update user stats
      updateUserStats(score, quizQuestions.length, Math.abs(secondsElapsed));
      updateDashboard();
      
      questionContainer.innerHTML = `
        <div class="card result-card">
          <i class="bi bi-trophy-fill result-icon text-warning"></i>
          <h2>Quiz Completed!</h2>
          <div class="score-display">${score}/${quizQuestions.length}</div>
          <div class="performance-message">${resultMessage}</div>
          <p>Time spent: ${timeSpent}</p>
          <div class="mt-4">
            <button id="restart-quiz" class="btn btn-primary">
              <i class="bi bi-arrow-repeat"></i> Try Again
            </button>
            <button id="show-answers" class="btn btn-outline-primary mx-2">
              <i class="bi bi-list-check"></i> Review Answers
            </button>
            <button id="new-quiz" class="btn btn-outline-primary">
              <i class="bi bi-list-ul"></i> New Quiz
            </button>
          </div>
        </div>
      `;
      
      optionsContainer.innerHTML = '';
      nextQuestionBtn.style.display = 'none';
      markQuestionBtn.style.display = 'none';
      clearSelectionBtn.style.display = 'none';
      questionNavigation.innerHTML = '';
      
      document.getElementById('restart-quiz').addEventListener('click', () => {
        prepareQuizQuestions();
        quizArea.classList.remove('d-none');
        startQuiz();
        nextQuestionBtn.style.display = 'block';
        markQuestionBtn.style.display = 'block';
        clearSelectionBtn.style.display = 'block';
      });
      
      document.getElementById('show-answers').addEventListener('click', showAnswers);
      
      document.getElementById('new-quiz').addEventListener('click', () => {
        quizArea.classList.add('d-none');
        dashboard.classList.remove('d-none');
        resetQuizState();
      });
    }

    function showAnswers() {
      questionContainer.innerHTML = `
        <div class="card">
          <div class="card-body">
            <h2 class="card-title mb-4">Quiz Review</h2>
            <div class="answer-review" id="answers-container"></div>
            <button id="back-to-results" class="btn btn-primary mt-3">
              <i class="bi bi-arrow-left"></i> Back to Results
            </button>
          </div>
        </div>
      `;
      
      const answersContainer = document.getElementById('answers-container');
      
      quizQuestions.forEach((question, index) => {
        const answerItem = document.createElement('div');
        answerItem.className = 'answer-item';
        
        // Show question number with range info if applicable
        let questionNumber = index + 1;
        if (useRangeSelection) {
          questionNumber = rangeFrom + index;
        }
        
        const userAnswer = userAnswers[index];
        const isCorrect = userAnswer === question.correctanswer;
        
        // Create options display
        const optionsHtml = ['A', 'B', 'C', 'D'].map(option => {
          if (!question['option' + option.toLowerCase()]) return '';
          
          const isCorrectOption = option === question.correctanswer;
          const isUserAnswer = userAnswer === option;
          
          let optionClass = 'answer-option';
          if (isCorrectOption) optionClass += ' correct-option';
          if (isUserAnswer) {
            optionClass += isCorrect ? ' user-correct' : ' user-selected';
          }
          
          return `
            <div class="${optionClass}">
              ${option}. ${question['option' + option.toLowerCase()]}
              ${isCorrectOption ? ' (Correct)' : ''}
              ${isUserAnswer && !isCorrectOption ? ' (Your answer)' : ''}
            </div>
          `;
        }).join('');
        
        answerItem.innerHTML = `
          <h5>Question ${questionNumber}: ${question.question}</h5>
          <div class="answer-options">
            ${optionsHtml}
          </div>
          ${question.explanation ? `
            <div class="explanation mt-2">
              <strong>Explanation:</strong> ${question.explanation}
            </div>
          ` : ''}
          <div class="mt-2">
            <strong>Your answer:</strong> 
            <span class="${isCorrect ? 'text-success' : 'text-danger'}">
              ${userAnswer || 'Not answered'} 
              ${isCorrect ? '✓' : '✗'}
            </span>
          </div>
          <hr class="my-3">
        `;
        answersContainer.appendChild(answerItem);
      });
      
      document.getElementById('back-to-results').addEventListener('click', endQuiz);
    }

    function updateUserStats(score, totalQuestions, timeSpent) {
      userStats.completedQuizzes++;
      userStats.totalTime += timeSpent;
      userStats.totalScore += (score / totalQuestions) * 100;
      
      // Update streak
      const passThreshold = 0.6; // 60% to maintain streak
      if ((score / totalQuestions) >= passThreshold) {
        userStats.currentStreak++;
        if (userStats.currentStreak > userStats.bestStreak) {
          userStats.bestStreak = userStats.currentStreak;
        }
      } else {
        userStats.currentStreak = 0;
      }
      
      // Update topic progress
      if (!userStats.topicProgress[currentTopic]) {
        userStats.topicProgress[currentTopic] = {
          answered: 0,
          correct: 0
        };
      }
      
      userStats.topicProgress[currentTopic].answered += totalQuestions;
      userStats.topicProgress[currentTopic].correct += score;
      
      // Save to localStorage
      localStorage.setItem('userStats', JSON.stringify(userStats));
    }

    function loadUserStats() {
      const savedStats = localStorage.getItem('userStats');
      if (savedStats) {
        userStats = JSON.parse(savedStats);
      }
    }

    function updateDashboard() {
      completedQuizzes.textContent = userStats.completedQuizzes;
      totalTime.textContent = formatTime(userStats.totalTime);
      
      const avgScore = userStats.completedQuizzes > 0 ? 
        Math.round(userStats.totalScore / userStats.completedQuizzes) : 0;
      averageScore.textContent = `${avgScore}%`;
      
      currentStreak.textContent = userStats.currentStreak;
    }

    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = seconds % 60;
      
      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      } else if (minutes > 0) {
        return `${minutes}m ${remainingSeconds}s`;
      } else {
        return `${remainingSeconds}s`;
      }
    }

    function getPerformanceMessage(percentage) {
      if (percentage >= 90) return "Outstanding! You've mastered this topic.";
      if (percentage >= 75) return "Excellent work! You have a strong understanding.";
      if (percentage >= 60) return "Good job! You're on the right track.";
      if (percentage >= 50) return "Not bad! Review the explanations to improve.";
      return "Keep practicing! Review the material and try again.";
    }

    function resetQuizState() {
      currentQuestionIndex = 0;
      selectedOption = null;
      secondsElapsed = 0;
      userAnswers = [];
      markedQuestions = [];
      clearInterval(timerInterval);
      quizTimer.textContent = '00:00';
      nextQuestionBtn.style.display = 'block';
      markQuestionBtn.style.display = 'block';
      clearSelectionBtn.style.display = 'block';
      nextQuestionBtn.disabled = true;
      useRangeSelection = false;
    }

    function showLoading() {
      loadingIndicator.style.display = 'block';
    }

    function hideLoading() {
      loadingIndicator.style.display = 'none';
    }

    function showMessage(message, type = 'info') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alert.style.top = '70px';
      alert.style.right = '20px';
      alert.style.zIndex = '1050';
      alert.style.minWidth = '300px';
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alert);
      
      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, 5000);
    }

    // Fisher-Yates shuffle algorithm
    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }
  </script>
</body>
</html>
